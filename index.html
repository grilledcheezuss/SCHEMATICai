<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cox Research | SCHEMATICai (v2.33)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    
    <script src="database.js"></script>

    <script>
        try {
            const session = JSON.parse(localStorage.getItem('cox_auth_session'));
            if (session && session.expiry > Date.now()) {
                document.documentElement.classList.add('logged-in');
            }
        } catch(e) {}
    </script>
    
    <style>
        /* --- THEME VARIABLES (v2.30) --- */
        :root { 
            --app-primary: #461D7C;       
            --app-accent: #6A3C9E;        
            --app-gradient: linear-gradient(135deg, #461D7C 0%, #2e0e57 100%);
            
            accent-color: var(--app-primary);
            
            --bg-app: #e3e5e8; 
            --bg-sidebar: #ffffff; 
            --bg-card: #ffffff;
            --bg-controls: rgba(255,255,255,0.98); 
            --bg-viewer: #323639; 
            --bg-input: #ffffff;
            
            --bg-modal: rgba(248, 245, 255, 0.98); 
            
            --text-primary: #121212; 
            --text-secondary: #5f6368; 
            --text-panel-header: #461D7C; 
            --border-color: #c7c7cc; 
            
            --status-success: #1b5e20; 
            --status-warning: #f57f17; 
            --status-error: #b71c1c; 
            
            /* Badge Palette */
            --badge-match-bg: #e8f5e9;    --badge-match-text: #1b5e20;
            --badge-varies-bg: #fff3e0;   --badge-varies-text: #c65304; 
            --badge-conflict-bg: #ffebee; --badge-conflict-text: #b71c1c; 
            --badge-neutral-bg: #f5f5f5;  --badge-neutral-text: #424242;
            
            --header-height: 80px; 
            --input-height: 48px;
            
            --z-header: 100;
            --z-sidebar: 20;
            --z-modal: 10000;
            --z-overlay: 20000;
            
            color-scheme: light; 
        }

        body.dark-mode {
            --bg-app: #121212; --bg-sidebar: #1e1e1e; --bg-card: #2d2d2d; 
            --bg-controls: rgba(30, 30, 30, 0.98); --bg-viewer: #1a1a1a; 
            --bg-input: #383838;
            
            --bg-modal: rgba(30, 30, 30, 0.98); 
            
            --text-panel-header: #d1c4e9; 
            --text-primary: #e8eaed; --text-secondary: #9aa0a6; --border-color: #3c4043;
            
            --status-success: #81c784; 
            --status-warning: #ffb74d; 
            --status-error: #e57373;
            
            --badge-match-bg: #1b3d21;    --badge-match-text: #a5d6a7;
            --badge-varies-bg: #4a3316;   --badge-varies-text: #ffcc80;
            --badge-conflict-bg: #4c1a1a; --badge-conflict-text: #ef9a9a;
            --badge-neutral-bg: #3c4043;  --badge-neutral-text: #e8eaed;
            
            color-scheme: dark;            
        }
        
        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; background-color: var(--bg-app); color: var(--text-primary); height: 100vh; display: flex; flex-direction: column; overflow: hidden; font-size: 15px; }

        ::selection { background: var(--app-accent); color: white; }

        /* CRASH SCREEN */
        #crash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #330000; z-index: 30000; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; color: white; display: none; }
        .error-box { background: #550000; padding: 30px; border-radius: 12px; border: 1px solid #ff5555; max-width: 500px; box-shadow: 0 20px 60px rgba(0,0,0,0.6); }

        header { background: var(--app-gradient); height: var(--header-height); padding: 0 25px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: var(--z-header); flex-shrink: 0; position: relative; }
        .logo-group { text-decoration: none; display: flex; flex-direction: column; line-height: 1; z-index: 2; }
        .logo-main { font-family: 'Helvetica Neue', Arial, sans-serif; font-size: 2.2rem; font-weight: 900; color: white; letter-spacing: -1px; text-transform: uppercase; }
        .logo-sub { font-family: 'Helvetica Neue', Arial, sans-serif; font-size: 0.75rem; color: #b39ddb; font-weight: 700; letter-spacing: 4px; text-transform: uppercase; margin-top: 4px; }
        .version-badge { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.3); color: white; padding: 8px 20px; border-radius: 20px; font-weight: 800; font-size: 14px; letter-spacing: 1px; pointer-events: none; white-space: nowrap; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .version-text-ai { font-style: italic; color: #d1c4e9; }
        .header-controls { display: flex; align-items: center; gap: 12px; z-index: 2; margin-left: auto; }
        
        .control-btn { background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.3); color: white; width: 42px; height: 42px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; transition: all 0.2s; overflow: hidden; }
        .control-btn.active { background: var(--app-accent); border-color: white; box-shadow: 0 0 15px rgba(106, 60, 158, 0.6); transform: scale(1.1); }
        .control-btn:hover { background: rgba(255,255,255,0.3); }
        .btn-bug { padding: 0; font-size: 0; color: transparent; }
        .bug-icon-img { width: 100%; height: 100%; object-fit: cover; display: block; }
        
        /* Fallback */
        .btn-bug.image-missing { font-size: 20px; color: white; } 
        .btn-bug.image-missing::after { content: 'üêû'; }
        
        .header-separator { width: 1px; height: 24px; background: rgba(255,255,255,0.2); margin: 0 5px; }
        .btn-logout { color: #ffcccc; border-color: rgba(255, 200, 200, 0.3); margin-left: 5px; }
        .btn-logout:hover { background: var(--status-error); border-color: var(--status-error); color: white; }
        .btn-bug:hover { background: var(--status-warning); border-color: var(--status-warning); color: white; }

        /* DROPDOWN - FORCED STYLE */
        .cox-input { width: 100%; height: var(--input-height); padding: 0 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; background: var(--bg-input); color: var(--text-primary); outline: none; transition: border-color 0.2s; box-sizing: border-box; appearance: none; transform: translateZ(0); }
        
        select.cox-input { 
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%235f6368' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); 
            background-repeat: no-repeat; background-position: right 10px center; background-size: 16px; padding-right: 30px; 
            color-scheme: dark; 
        }
        
        ::selection { background: var(--app-primary); color: white; }
        .cox-input:focus { border-color: var(--app-primary); box-shadow: 0 0 0 2px rgba(70, 29, 124, 0.25); }
        option { background-color: var(--bg-app); color: var(--text-primary); }

        #app-container { display: none; flex: 1; overflow: hidden; height: calc(100vh - var(--header-height)); position: relative; }
        html.logged-in #auth-overlay { display: none !important; } html.logged-in #app-container { display: flex !important; }
        
        /* AUTH OVERLAY & AVATAR OVERLAY (v2.30) */
        #auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-app); z-index: var(--z-overlay); display: flex; align-items: flex-start; justify-content: center; overflow-y: auto; padding: 50px 0; }
        .auth-card { background: var(--bg-card); padding: 40px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); width: 100%; max-width: 1000px; text-align: center; border: 1px solid var(--border-color); position: relative; margin: auto; }
        
        /* AVATAR OVERLAY STYLES */
        .auth-avatar-container { position: relative; width: 100px; height: 100px; margin: 0 auto 20px auto; border-radius: 50%; overflow: hidden; border: 3px solid var(--app-primary); }
        /* FIXED: Changed to .jpg */
        .auth-avatar { width: 100%; height: 100%; object-fit: cover; display: block; }
        .auth-overlay-icon { position: absolute; top: 0; left: 0; width: 100%; height: 100%; padding: 15px; background: rgba(70, 29, 124, 0.6); mix-blend-mode: screen; opacity: 0.9; }
        
        .login-video-container { margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 20px; position: relative; width: 100%; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 8px; }
        .login-video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }

        .auth-btn { width: 100%; padding: 12px; background: var(--app-primary); color: white; border: none; border-radius: 6px; font-weight: 700; font-size: 16px; cursor: pointer; margin-top: 10px; transition: 0.2s; }
        .auth-error { color: var(--status-error); margin-top: 10px; font-size: 13px; display: none; font-weight: 700; }
        .auth-success { color: var(--status-success); margin-top: 10px; font-size: 13px; font-weight: 700; display: none; }
        .auth-toggle { margin-top: 20px; font-size: 13px; color: var(--text-secondary); text-decoration: underline; cursor: pointer; display: block; }
        #auth-register-view { display: none; }

        #sidebar { width: var(--sidebar-width); min-width: 320px; background: var(--bg-sidebar); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; z-index: var(--z-sidebar); transition: width 0.3s ease; }
        .sidebar-controls { padding: 15px; background: var(--bg-controls); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 10px; }
        .sidebar-controls.collapsed .input-group, .sidebar-controls.collapsed .action-row, .sidebar-controls.collapsed #demo-inputs-container, .sidebar-controls.collapsed .filter-grid { display: none !important; }
        .filter-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .input-group { display: flex; flex-direction: column; gap: 2px; }
        .input-label { font-size: 10px; font-weight: 800; text-transform: uppercase; color: var(--text-secondary); padding-left: 2px; }
        .action-row { display: flex; gap: 8px; margin-top: 2px; }
        
        .search-btn { height: 38px; background: var(--app-gradient); color: white; border: none; border-radius: 6px; font-weight: 800; cursor: pointer; font-size: 14px; flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; line-height: 1.1; transition: opacity 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .search-btn:disabled { opacity: 0.6; cursor: wait; background: #555; }
        .search-btn-sub { font-size: 10px; font-weight: 400; opacity: 0.9; margin-top: 1px; }
        .reset-btn { height: 38px; width: 40px; background: var(--bg-app); color: var(--text-secondary); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; flex: 0 0 auto; }
        
        .refine-search-btn { display: none; width: 100%; padding: 8px; background: var(--bg-app); border: 1px dashed var(--app-primary); color: var(--app-primary); font-weight: 700; border-radius: 6px; cursor: pointer; margin-bottom: 5px; font-size: 12px; }
        .sidebar-controls.collapsed .refine-search-btn { display: block; }
        
        #demo-inputs-container { display: none; flex-direction: column; gap: 8px; margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border-color); background: rgba(70, 29, 124, 0.05); padding: 10px; border-radius: 6px; border: 1px solid var(--app-accent); }
        .demo-label { font-size: 10px; font-weight: 800; color: var(--app-primary); text-transform: uppercase; margin-bottom: 2px; }
        .input-wrapper { position: relative; width: 100%; }
        .search-redaction { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 10; display: none; align-items: center; padding-left: 10px; border-radius: 8px; pointer-events: none; }
        .search-redaction.active { display: flex; }
        .redaction-tag { background: #f3f4f6; color: #9ca3af; font-size: 10px; font-weight: 800; padding: 2px 6px; border-radius: 4px; border: 1px solid #e5e7eb; text-transform: uppercase; letter-spacing: 1px; }

        #results-scroll-area { flex: 1; overflow-y: auto; padding: 15px; background: var(--bg-app); scroll-behavior: smooth; }
        #results-area { display: flex; flex-direction: column; gap: 8px; max-width: 100%; margin: 0 auto; padding-bottom: 80px; }
        
        .record-card { background: var(--bg-card); padding: 6px 10px; border-radius: 8px; border: 1px solid var(--border-color); border-left: 5px solid var(--app-primary); box-shadow: 0 1px 3px rgba(0,0,0,0.05); cursor: default; position: relative; display: flex; flex-direction: column; gap: 2px; transition: all 0.2s; }
        .record-card.has-pdf { cursor: pointer; }
        .record-card.has-pdf:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-color: var(--app-accent); z-index: 20; }
        .record-card.active-view { border-color: var(--app-accent); background: rgba(70, 29, 124, 0.05); border-left-width: 6px; box-shadow: 0 0 0 2px rgba(106, 60, 158, 0.2); }
        .record-card.low-score { background-color: var(--fail-bg); border-color: var(--fail-border); border-left-color: var(--fail-color); opacity: 0.95; }
        .record-card:hover::after { content: attr(data-card-tooltip); position: absolute; top: 100%; left: 50%; transform: translateX(-50%); background: var(--tooltip-bg); color: var(--tooltip-text); padding: 6px 12px; border-radius: 6px; font-size: 12px; white-space: nowrap; pointer-events: none; z-index: 100; margin-top: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); opacity: 0; animation: fadeIn 0.2s forwards; }
        
        .panel-label { font-size: 9px; font-weight: 800; text-transform: uppercase; opacity: 0.8; color: var(--text-secondary); }
        .panel-name { font-size: 18px; font-weight: 800; color: var(--text-panel-header); line-height: 1.1; margin: 2px 0; letter-spacing: -0.5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
        
        .hud-row { display: flex; gap: 4px; margin-top: 2px; flex-wrap: wrap; align-items: center; }
        .hud-badge { font-size: 9px; font-weight: 700; text-transform: uppercase; padding: 1px 5px; border-radius: 3px; position: relative; background: var(--badge-neutral-bg); color: var(--badge-neutral-text); }
        .hud-badge.match { background-color: var(--badge-match-bg) !important; color: var(--badge-match-text) !important; border: 1px solid var(--badge-match-bg); }
        .hud-badge.varies { background-color: var(--badge-varies-bg) !important; color: var(--badge-varies-text) !important; }
        .hud-badge.conflict { background-color: var(--badge-conflict-bg) !important; color: var(--badge-conflict-text) !important; }
        .hud-badge.warning { background-color: var(--badge-warning-bg) !important; color: var(--badge-warning-text) !important; border: 1px solid var(--badge-warning-text); }
        .hud-badge.predict { background-color: var(--badge-predict-bg) !important; color: var(--badge-predict-text) !important; border: 1px solid var(--badge-predict-text); }
        .hud-badge.learned { background-color: var(--badge-learned-bg) !important; color: var(--badge-learned-text) !important; border: 1px solid var(--badge-learned-bg); }
        .hud-badge.healed { background-color: var(--badge-healed-bg) !important; color: var(--badge-healed-text) !important; border: 1px solid var(--badge-healed-text); }
        
        .rl-actions { margin-left: auto; display: flex; gap: 8px; }
        .btn-rl { background: transparent; border: 1px solid var(--border-color); color: var(--text-secondary); border-radius: 4px; padding: 1px 6px; cursor: pointer; font-size: 12px; transition: all 0.2s; display:flex; align-items:center; justify-content:center; }
        .btn-mismatch:hover { background: var(--status-error); color: white; border-color: var(--status-error); }
        .btn-match:hover { background: var(--status-success); color: white; border-color: var(--status-success); }
        .btn-match:disabled { opacity: 0.5; cursor: default; }
        .btn-match.learned { background: var(--status-success); color: white; border-color: var(--status-success); pointer-events: none; }

        #feedback-modal, #governance-modal, #bug-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: transparent; z-index: var(--z-modal); }
        #governance-modal, #bug-modal { background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); align-items: center; justify-content: center; }
        #feedback-modal { pointer-events: none; }
        #feedback-modal.active, #governance-modal.active, #bug-modal.active { display: flex; }
        #feedback-modal.active { display: block; } 

        .modal-card { 
            width: 320px; position: absolute; bottom: 20px; right: 20px; pointer-events: auto; text-align: center; 
            background: var(--bg-modal);
            backdrop-filter: blur(10px);
            border: 1px solid var(--app-primary);
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.25);
            overflow: hidden;
        }
        
        .gov-card, .bug-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.4); overflow: hidden; }
        
        .modal-header, .gov-header, .tuner-header, .bug-header { background: var(--app-gradient); padding: 12px 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; color: white; }
        .modal-title, .gov-title { font-size: 14px; font-weight: 800; color: white; margin: 0; }
        .modal-subtitle { font-size: 11px; color: rgba(255,255,255,0.7); display: block; margin-top: 1px; }
        
        .modal-content { padding: 15px; }
        
        .gov-card { width: 600px; max-height: 80vh; display: flex; flex-direction: column; }
        .gov-content { flex: 1; overflow-y: auto; padding: 0; }
        .gov-item { padding: 12px 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .gov-panel { font-weight: 800; font-size: 13px; color: var(--app-primary); }
        .gov-action { background: var(--status-error); color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 10px; font-weight: 700; }
        .gov-footer { padding: 12px 15px; background: var(--bg-sidebar); border-top: 1px solid var(--border-color); display: flex; gap: 8px; }
        .gov-dashboard { padding: 12px; background: rgba(70, 29, 124, 0.05); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-around; align-items: center; }
        .stat-val { font-size: 18px; font-weight: 900; color: var(--app-primary); }
        .stat-lbl { font-size: 9px; text-transform: uppercase; color: var(--text-secondary); letter-spacing: 1px; margin-top: 2px; }
        
        .bug-card { width: 500px; padding: 0; }
        .bug-textarea { width: 100%; height: 100px; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; margin: 20px; width: calc(100% - 40px); font-family: inherit; resize: vertical; }

        #tuner-panel { width: 0; background: var(--bg-sidebar); border-left: 1px solid var(--border-color); display: flex; flex-direction: column; transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); overflow: hidden; z-index: 15; position: relative; }
        #tuner-panel.open { width: 400px; border-left: 2px solid var(--app-primary); }
        .tuner-content-wrapper { min-width: 400px; padding: 0; display: flex; flex-direction: column; height: 100%; }
        .tuner-body { padding: 20px; overflow-y: auto; flex: 1; }
        
        .feedback-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        .feedback-detail-view { display: flex; flex-direction: column; gap: 5px; text-align: left; }
        .feedback-detail-label { font-size: 10px; font-weight: 700; color: var(--app-primary); text-transform: uppercase; }

        .reason-btn { 
            width: 100%; padding: 8px; 
            border: 1px solid #d1c4e9; 
            background: var(--bg-input); 
            color: var(--text-primary); 
            border-radius: 6px; text-align: left; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-size: 11px; font-weight: 600; transition: all 0.2s; 
        }
        .reason-btn:hover { border-color: var(--app-primary); background: var(--badge-predict-bg); color: var(--app-primary); }
        .reason-btn:disabled { opacity: 0.5; cursor: not-allowed; background: #eee; border-color: #ccc; color: #999; }

        .submit-feedback-btn { flex: 1; padding: 10px; background: var(--app-primary); color: white; border: none; border-radius: 6px; font-weight: 800; cursor: pointer; font-size: 12px;}
        .undo-btn { flex: 1; padding: 10px; background: var(--bg-input); border: 2px solid var(--text-primary); color: var(--text-primary); font-size: 12px; font-weight: 800; cursor: pointer; border-radius: 6px; }
        .undo-btn:hover { background: var(--text-primary); color: var(--bg-card); }

        .btn-export { flex: 1; padding: 10px; border-radius: 6px; font-weight: 700; cursor: pointer; border: none; color: white; font-size: 12px; text-transform: uppercase; }
        .btn-export.cloud { background: var(--app-primary); }
        .btn-export.csv { background: var(--status-success); }
        .btn-close { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 6px; padding: 2px 10px; cursor: pointer; font-size: 11px; font-weight: 700; }
        .btn-close:hover { background: rgba(255,255,255,0.4); }

        #preview-pane { flex: 1; background: var(--bg-viewer); position: relative; display: flex; flex-direction: column; overflow: hidden; min-width: 0; }
        #pdf-render-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .page-container { position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.5); width: auto; max-width: 100%; transition: width 0.3s ease; background: white; }
        .pdf-canvas { display: block; max-width: 100%; height: auto !important; }
        .overlay-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .placeholder-msg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: rgba(255,255,255,0.5); opacity: 0.8; font-size: 22px; }
        
        .mobile-toolbar { display: none; width: 100%; padding: 20px; background: #2a2a2a; justify-content: space-between; align-items: center; z-index: 3000; }
        .mobile-btn { padding: 12px 24px; border-radius: 10px; font-weight: 800; color: white; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; }

        @media (max-width: 900px) { 
            body { overflow: hidden; }
            .filter-grid { grid-template-columns: 1fr; }
            .sidebar-controls { max-height: 60vh; overflow-y: auto; }
            #sidebar { width: 100%; min-width: 0; height: 100%; z-index: 10; }
            #tuner-panel { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5000; display: none; }
            #tuner-panel.open { display: flex; width: 100%; }
            #preview-pane { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000; display: none; background: #1a1a1a; }
            #preview-pane.active { display: flex; flex-direction: column; }
            .mobile-toolbar { display: flex; }
            header { height: auto; padding: 20px; flex-wrap: wrap; gap: 15px; }
            .gov-card { width: 100%; height: 100%; border-radius: 0; }
            .version-badge { margin-top: 10px; position: static; transform: none; width: 100%; text-align: center; }
            .modal-card { bottom: 0; right: 0; width: 100%; border-radius: 12px 12px 0 0; }
        }
    </style>
</head>
<body>

<div id="crash-screen" style="display:none;">
    <div class="error-box">
        <div style="font-size:50px; margin-bottom:10px;">üí•</div>
        <h2>Critical Data Error</h2>
        <p id="error-msg" style="color:#ffcccc; line-height:1.5; margin-bottom:20px;">System Failure.</p>
        <button class="reset-btn-hard" onclick="DatabaseService.hardReset()" style="background:white; color:#550000; border:none; padding:10px 20px; border-radius:6px; font-weight:800; cursor:pointer;">‚ö† HARD RESET DATABASE</button>
    </div>
</div>

<div id="auth-overlay">
    <div class="auth-card">
        <div class="auth-avatar-container">
            <img src="image_f7315b.jpg" alt="User" class="auth-avatar">
            <img src="image_16.png" alt="Overlay" class="auth-overlay-icon">
        </div>
        <h2 style="margin:0 0 10px 0; color:var(--app-primary)">SCHEMATICai</h2>
        <div id="auth-login-view">
            <input type="text" id="auth-user" class="cox-input" placeholder="Username" onkeyup="if(event.key==='Enter') AuthService.login()">
            <input type="password" id="auth-pin" class="cox-input" style="margin-top:10px;" placeholder="Passcode / PIN" onkeyup="if(event.key==='Enter') AuthService.login()">
            <button class="auth-btn" onclick="AuthService.login()">Authenticate</button>
            <a class="auth-toggle" onclick="AuthService.toggleRegister()">First time? Register here</a>
        </div>
        <div id="auth-register-view">
            <input type="text" id="reg-user" class="cox-input" placeholder="Your Assigned Username">
            <button class="auth-btn" id="check-user-btn" onclick="AuthService.checkUser()">Verify Username</button>
            <div id="reg-step-2" style="display:none; margin-top:15px; border-top:1px solid var(--border-color); padding-top:15px;">
                <input type="password" id="reg-pass" class="cox-input" placeholder="Create Passcode">
                <input type="password" id="reg-confirm" class="cox-input" style="margin-top:10px;" placeholder="Confirm Passcode">
                <button class="auth-btn" onclick="AuthService.finalizeRegistration()">Complete Registration</button>
            </div>
            <a class="auth-toggle" onclick="AuthService.toggleRegister()">Back to Login</a>
        </div>
        <div class="login-video-container">
            <iframe class="login-video" src="https://www.youtube-nocookie.com/embed/vEzBFpontU0?autoplay=1&mute=1&loop=1&playlist=vEzBFpontU0&controls=0&rel=0" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
        </div>
    </div>
</div>

<header>
    <a href="https://coxresearch.com/" class="logo-group">
        <span class="logo-main">COX</span>
        <span class="logo-sub">RESEARCH</span>
    </a>
    
    <div class="version-badge">SCHEMATIC<span class="version-text-ai">ai</span> v2.33</div>

    <div class="header-controls">
        <button class="control-btn btn-bug" onclick="BugController.open()" title="Report Bug">
            <img src="image_f7315b.jpg" alt="Bug Report" class="bug-icon-img" onerror="this.style.display='none'; this.parentNode.classList.add('image-missing');">
        </button>
        <button class="control-btn" id="demoToggle" onclick="UI.toggleDemoMode()" title="Toggle Demo Mode">üëÅÔ∏è‚Äçüó®Ô∏è</button>
        <button class="control-btn" id="tunerToggle" onclick="UI.toggleTuner()" style="display:none;" title="Adjust Redaction Zones">‚öôÔ∏è</button>
        <button class="control-btn dark-mode-btn" onclick="UI.toggleDarkMode()" title="Toggle Dark Mode">üåì</button>
        <div class="header-separator"></div>
        <button class="control-btn btn-logout" onclick="AuthService.logout()" title="Logout">‚èª</button>
    </div>
</header>

<div id="feedback-modal">
    <div class="modal-card">
        <div class="modal-header">
            <span class="modal-title">Improve the AI</span>
            <button class="btn-close" onclick="UI.closeFeedbackModal()">X</button>
        </div>
        <div class="modal-content" id="modal-content"></div>
    </div>
</div>

<div id="bug-modal">
    <div class="bug-card">
        <div class="modal-header">
            <span class="modal-title">üêû Report a Bug</span>
            <button class="btn-close" onclick="BugController.close()">X</button>
        </div>
        <textarea id="bug-desc" class="bug-textarea" placeholder="What happened? e.g., 'Search failed on 480V'"></textarea>
        <img id="bug-preview-img" class="bug-preview">
        <div style="padding:20px; text-align:right;">
            <button class="submit-feedback-btn" onclick="BugController.send()">Send Report</button>
        </div>
    </div>
</div>

<div id="governance-modal">
    <div class="gov-card">
        <div class="gov-header">
            <span class="gov-title">AI Governance Log</span>
            <button class="btn-close" onclick="UI.closeGovModal()">Close</button>
        </div>
        <div class="gov-dashboard">
            <div class="stat-box"><span class="stat-val" id="stat-total">0</span><span class="stat-lbl">Total Records</span></div>
            <div class="stat-box"><span class="stat-val" id="stat-healed">0</span><span class="stat-lbl">AI Repaired</span></div>
        </div>
        <div class="gov-content" id="gov-list"></div>
        <div class="gov-footer">
            <button class="btn-export cloud" onclick="GoldenRecordManager.uploadToCloud(this)">‚òÅ UPLOAD TO CLOUD DB (UC)</button>
            <button class="btn-export csv" onclick="GoldenRecordManager.export('csv')">‚¨á CSV</button>
        </div>
    </div>
</div>

<div id="app-container">
    <div id="sidebar">
        <div class="sidebar-controls">
            <button class="refine-search-btn" onclick="UI.toggleSearchUI(true)">üîç REFINE SEARCH / EDIT FILTERS</button>
            <div class="input-group"><span class="input-label">Keywords</span><div class="input-wrapper"><input type="text" id="keywordInput" class="cox-input" placeholder="e.g. Duplex, 1PH, CP-7920" onkeypress="UI.handleEnter(event)" disabled><div id="keywordRedaction" class="search-redaction"><span class="redaction-tag">[REDACTED]</span></div></div></div>
            <div class="filter-grid">
                <div class="input-group"><span class="input-label">Manufacturer</span><select id="mfgInput" class="cox-input" disabled><option value="">Any</option></select></div>
                <div class="input-group"><span class="input-label">Phase</span><select id="phaseInput" class="cox-input" disabled><option value="">Any</option></select></div>
                <div class="input-group"><span class="input-label">HP</span><select id="hpInput" class="cox-input" disabled><option value="">Any</option></select></div>
                <div class="input-group"><span class="input-label">Voltage</span><select id="voltInput" class="cox-input" disabled><option value="">Any</option></select></div>
                <div class="input-group"><span class="input-label">Enclosure</span><select id="enclosureInput" class="cox-input" disabled><option value="">Any</option></select></div>
            </div>
            <div class="action-row"><button class="reset-btn" onclick="UI.resetSearch()" title="Clear All" disabled>‚Ü∫</button><button class="search-btn" id="searchBtn" disabled onclick="SearchEngine.perform()"><span>SEARCH</span><span class="search-btn-sub">Init...</span></button></div>
            <div id="demo-inputs-container"><div class="demo-label">Demo Configuration</div><input type="text" class="cox-input demo-input" id="demoCustomerInput" placeholder="Client Name" oninput="PdfController.updateRedactions();"><input type="text" class="cox-input demo-input" id="demoJobInput" placeholder="Job Name" oninput="PdfController.updateRedactions();"><input type="text" class="cox-input demo-input" id="demoStageInput" placeholder="Job Stage" oninput="PdfController.updateRedactions();"><input type="text" class="cox-input demo-input" id="demoDateInput" placeholder="Date" oninput="PdfController.updateRedactions();"></div>
            <div class="filter-row">
                <select class="cox-input filter-select" id="resultFilter" onchange="SearchEngine.applyFilter(false)" disabled>
                    <option value="ALL">Show Matches (Green & Orange)</option>
                    <option value="EXACT">Perfect Only (Green)</option>
                    <option value="VARIABLE">Varied Only (Orange)</option>
                    <option value="MISMATCH">Show Mismatches (Red)</option>
                </select>
            </div>
        </div>
        <div id="results-scroll-area"><div id="top-pagination"></div><div id="results-area"></div><div id="pagination-area"></div></div>
    </div>
    
    <div id="preview-pane">
        <div class="mobile-toolbar">
            <button class="mobile-btn btn-close" onclick="UI.closePdf()">‚úñ CLOSE</button>
            <a id="mobile-open-link" class="mobile-btn btn-open" target="_blank" href="#">OPEN FULL PDF ‚Üó</a>
        </div>
        <div class="placeholder-msg" id="preview-placeholder"><span style="font-size:48px;">üìÑ</span><br><br>Select a schematic</div>
        <div id="pdf-render-container"></div>
    </div>

    <div id="tuner-panel">
        <div class="tuner-content-wrapper"><div class="tuner-header"><span>REDACTION ZONES</span><button class="btn-close" onclick="UI.toggleTuner()">Close</button></div><div class="tuner-body"><button class="btn-add-zone" onclick="PdfController.addZone()">+ Add Zone</button><div id="zone-list" style="margin-top:15px;"></div><button onclick="UI.toggleGovModal()" style="width:100%; padding:12px; background:var(--text-secondary); color:white; border:none; border-radius:8px; font-weight:700; cursor:pointer; margin-top: 15px; font-size:14px;">View Governance Log</button></div></div>
    </div>
</div>

<script>
// --- SCHEMATICai v2.33 ---
const STORAGE_KEYS = { SESSION: 'cox_auth_session', ZONES: 'cox_zones_v4_7', MARKOV: 'cox_markov_cache', VOCAB: 'cox_dynamic_vocab_v1', CRASH: 'cox_crash_count' };
const CONFIG = { MAIN_TOKEN: 'patrYO3CRLeH9mSdT.bfb9dd4fdf5c8b8d8c8f962c77952b0cdf9300f05bda43cd5a460a3c7413095a', MAIN_BASE_ID: 'appgc1pbuOgmODRpj', TABLE_ID: 'tblLnVHfkYAWjfQzN', USERS_TABLE_ID: 'Users', MARKOV_TOKEN: 'pattuUFU587Ez1zvc.633d35de2ed69f1272311006168394bd97a96e28ff97036bdf5eafe3484a0f44', MARKOV_BASE_ID: 'app88zF2k4FgjU8hK', HEALING_TABLE_ID: 'HealingData', GOLDEN_TABLE_ID: 'GoldenRecords', FIELDS: { TARGET: 'Items', NAME: 'Control Panel Name', PDF: 'Control Panel PDF' }, DB_NAME: 'CoxSchematicDB', STORES: { RECORDS: 'records', CONSENSUS: 'consensus' }, CONFIDENCE_THRESHOLD: 1, DECAY_MS: 90 * 24 * 60 * 60 * 1000, AI_MIN_RECORDS: 250 };
const CONSTANTS = { MANUFACTURERS: { 'gorman rupp':['gorman','gr'],'barnes':['barnes','sithe'],'hydromatic':['hydromatic','hydro-matic'],'flygt':['flygt'],'myers':['myers'],'goulds':['goulds'],'zoeller':['zoeller'],'liberty':['liberty'],'wilo':['wilo'],'pentair':['pentair'],'abs':['abs'],'aurora':['aurora'] }, KEYWORD_PHRASES: { 'lightning arrestor':['la','lightning'],'surge suppressor':['surge','spd'],'phase monitor':['phase','pm'],'transducer':['transducer','4-20ma'],'floats':['floats'],'seal fail':['seal','leak'],'duplex':['duplex','2 pump'],'simplex':['simplex'],'triplex':['triplex'] }, REGEX: { CLEAN_NAME: /(\.dwg|\.pdf|[!@#$%^&*()_+=|<>?{}[\]~`])/gi, PANEL_NUM: /CP[-]?\s*(\d+)/i }, BOM_SIGS: ['bill of materials', 'item qty manufacturer', 'item qty description', 'qty part number'], SCHEM_SIGS: ['schematic', 'wiring diagram', 'ladder diagram', 'elementary diagram', 'connection diagram', 'field wiring', 'power distribution'], NEGATIVE_PREFIXES: /(?:compatible|replaces|similar|style|replacement)\s+(?:with|to|for)?\s*/i, DATA: { HP: [0.5, 0.75, 1, 1.5, 2, 3, 5, 6.2, 7.5, 10, 15, 20, 25, 30, 40, 50, 60, 75, 100], VOLT: [120, 208, 240, 480, 575], PHASE: [1, 3], ENCLOSURE: ["NEMA 4X Stainless", "NEMA 4X Fiberglass", "Poly"] } };

window.onerror = function(msg, url, line, col, error) {
    document.getElementById('crash-screen').style.display = 'flex';
    document.getElementById('error-msg').innerText = `Runtime Error: ${msg}\nLine: ${line}`;
    console.error("Global Error:", error);
    return false; 
};

class GoldenRecordManager {
    static generate() { const goldenMap = new Map(); if(DatabaseService.allRecords.length) { DatabaseService.allRecords.forEach(rec => { const pMatch = (rec.fields[CONFIG.FIELDS.NAME]||'').match(CONSTANTS.REGEX.PANEL_NUM); const pNum = pMatch ? pMatch[1] : '0'; const txt = (rec.fields[CONFIG.FIELDS.TARGET]||'') + ' ' + (rec.fields[CONFIG.FIELDS.NAME]||''); const rawSpecs = SearchEngine.extractSpecs(txt); let final = { id: pNum, name: rec.fields[CONFIG.FIELDS.NAME] || '', hp: rawSpecs.hp.join('/') || '', volt: rawSpecs.volts.join('/') || '', phase: (rawSpecs.phaseScores.s3 > rawSpecs.phaseScores.s1) ? 3 : 1, manufacturer: SearchEngine.detectMfg(txt) || '', enclosure: "", source: "Raw", confidence: 0 }; if(pNum !== '0' && DatabaseService.masterData[pNum]) { const md = DatabaseService.masterData[pNum]; if(md.mfg && md.mfg !== 'N/A') { final.manufacturer = md.mfg; final.source = "Excel"; } if(md.hp && md.hp !== 'N/A') { final.hp = md.hp; final.source = "Excel"; } if(md.volt && md.volt !== 'N/A') { final.volt = md.volt; final.source = "Excel"; } } if(pNum !== '0') { const getHealed = (cat) => { const h = AIService.consensus[`${pNum}_${cat}`]; return (h && h.count >= CONFIG.CONFIDENCE_THRESHOLD) ? h : null; }; const hHP = getHealed('hp'); if(hHP) { final.hp = hHP.value; final.source = "Healed"; final.confidence = hHP.count; } const hVolt = getHealed('volt'); if(hVolt) { final.volt = hVolt.value; final.source = "Healed"; final.confidence = hVolt.count; } const hMfg = getHealed('mfg'); if(hMfg) { final.manufacturer = hMfg.value; final.source = "Healed"; final.confidence = hMfg.count; } const hEnc = getHealed('enclosure'); if(hEnc) { final.enclosure = hEnc.value; final.source = "Healed"; final.confidence = hEnc.count; } const hPh = getHealed('phase'); if(hPh) { final.phase = hPh.value; final.source = "Healed"; final.confidence = hPh.count; } } if(pNum !== '0') goldenMap.set(pNum, final); }); } return Array.from(goldenMap.values()).sort((a,b) => parseInt(b.id) - parseInt(a.id)); }
    static export(type) { const data = GoldenRecordManager.generate(); if(!data.length) { alert("No data."); return; } if(type === 'csv') { const headers = ["Panel ID", "Name", "HP", "Voltage", "Phase", "Manufacturer", "Enclosure", "Source", "Confidence"]; const rows = data.map(d => [ d.id, `"${d.name.replace(/"/g, '""')}"`, d.hp, d.volt, d.phase, d.manufacturer||'', d.enclosure||'', d.source, d.confidence ]); let csv = headers.join(",") + "\n"; rows.forEach(r => csv += r.join(",") + "\n"); const blob = new Blob([csv], {type: "text/csv"}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `Golden_Records_${Date.now()}.csv`; a.click(); } }
    static async uploadToCloud(btn) { /* ... */ }
}
class BugController {
    static blob = null;
    static init() { document.addEventListener('paste', (e) => { const modal = document.getElementById('bug-modal'); if(modal.style.display !== 'flex') return; const items = (e.clipboardData || e.originalEvent.clipboardData).items; for (const item of items) { if (item.kind === 'file' && item.type.startsWith('image/')) { this.blob = item.getAsFile(); const reader = new FileReader(); reader.onload = (evt) => { const img = document.getElementById('bug-preview-img'); img.src = evt.target.result; img.style.display = 'block'; }; reader.readAsDataURL(this.blob); } } }); }
    static open() { document.getElementById('bug-modal').style.display = 'flex'; document.getElementById('bug-desc').focus(); }
    static close() { document.getElementById('bug-modal').style.display = 'none'; document.getElementById('bug-desc').value = ''; document.getElementById('bug-preview-img').style.display = 'none'; this.blob = null; }
    static async send() { 
        const desc = document.getElementById('bug-desc').value; 
        if(!desc) { alert("Please describe the issue."); return; } 
        const user = JSON.parse(localStorage.getItem(STORAGE_KEYS.SESSION))?.user || "Unknown"; 
        const subject = `Bug Report - SCHEMATICai v2.30 - ${user}`; 
        const body = `User: ${user}%0D%0ADescription:%0D%0A${encodeURIComponent(desc)}`; 
        window.location.href = `mailto:nick@coxresearch.com?subject=${encodeURIComponent(subject)}&body=${body}`; 
        this.close(); 
    }
}
class VocabService {
    static data = { mfg:[], hp:[], volt:[], enclosure:[], phase:[] };
    static init() { try { const raw = localStorage.getItem(STORAGE_KEYS.VOCAB); if(raw) { const parsed = JSON.parse(raw); const now = Date.now(); Object.keys(parsed).forEach(cat => { if(!this.data[cat]) this.data[cat] = []; parsed[cat].forEach(item => { if (now - item.lastUsed < CONFIG.DECAY_MS) { this.data[cat].push(item); } }); }); this.save(); } } catch(e) {} }
    static add(cat, val) { if(!this.data[cat]) return; const normVal = val.toString().toUpperCase(); const existing = this.data[cat].find(i => i.value.toString().toUpperCase() === normVal); if(existing) { existing.lastUsed = Date.now(); } else { this.data[cat].push({ value: val, lastUsed: Date.now() }); } this.save(); }
    static save() { localStorage.setItem(STORAGE_KEYS.VOCAB, JSON.stringify(this.data)); }
    static get(cat) { return this.data[cat] || []; }
}
class AuthService {
    static EXPIRY_DAYS = 30; static tempRecordId = null;
    static init() { const session = JSON.parse(localStorage.getItem(STORAGE_KEYS.SESSION)); if (session && session.expiry > Date.now()) { document.getElementById('app-container').classList.add('visible'); return true; } document.getElementById('auth-overlay').style.display = 'flex'; document.getElementById('auth-login-view').style.display = 'block'; return false; }
    static toggleRegister() { const loginV = document.getElementById('auth-login-view'); const regV = document.getElementById('auth-register-view'); document.getElementById('auth-error').style.display = 'none'; if (loginV.style.display === 'none') { loginV.style.display = 'block'; regV.style.display = 'none'; } else { loginV.style.display = 'none'; regV.style.display = 'block'; } }
    static async checkUser() { /* ... */ }
    static async login() { 
        const user = document.getElementById('auth-user').value.trim(); 
        const pin = document.getElementById('auth-pin').value.trim(); 
        if(!user || !pin) return; 
        try { 
            const formula = `AND({Username}='${user}', {Passcode}='${pin}')`; 
            const url = `https://api.airtable.com/v0/${CONFIG.MARKOV_BASE_ID}/${CONFIG.USERS_TABLE_ID}?filterByFormula=${encodeURIComponent(formula)}`; 
            const resp = await fetch(url, { headers: { 'Authorization': `Bearer ${CONFIG.MARKOV_TOKEN}` } }); 
            const data = await resp.json(); 
            if (data.records && data.records.length > 0) { 
                const expiry = Date.now() + (this.EXPIRY_DAYS * 24 * 60 * 60 * 1000); 
                localStorage.setItem(STORAGE_KEYS.SESSION, JSON.stringify({ user: user, expiry: expiry })); 
                window.location.reload(); 
            } else { throw new Error("Invalid Credentials"); } 
        } catch (e) { alert("Login failed"); } 
    }
    static logout() { localStorage.removeItem(STORAGE_KEYS.SESSION); location.reload(); }
    static showApp() { document.getElementById('auth-overlay').style.display = 'none'; document.getElementById('app-container').classList.add('visible'); }
}
class DatabaseService {
    static db = null; static isLoaded = false; static allRecords = []; static masterData = {};
    static async init() { 
        console.log("[DB] Init...");
        return new Promise((resolve, reject) => { 
            const request = indexedDB.open(CONFIG.DB_NAME, 6); 
            request.onsuccess = e => { this.db = e.target.result; console.log("[DB] Opened"); resolve(); }; 
            request.onerror = e => { console.error("[DB] Open Fail", e); reject(e); };
            request.onupgradeneeded = e => { const d = e.target.result; if (!d.objectStoreNames.contains(CONFIG.STORES.RECORDS)) d.createObjectStore(CONFIG.STORES.RECORDS); if (!d.objectStoreNames.contains(CONFIG.STORES.CONSENSUS)) d.createObjectStore(CONFIG.STORES.CONSENSUS); }; 
        }); 
    }
    static async hardReset() { await this.nuke(); localStorage.clear(); window.location.reload(); }
    static async nuke() { if(this.db) this.db.close(); await new Promise(r=>setTimeout(r,500)); return new Promise(res=>{ indexedDB.deleteDatabase(CONFIG.DB_NAME).onsuccess=()=>res(true); }); }
    static async load() { 
        console.log("[DB] Loading Records...");
        return new Promise((resolve) => { 
            const tx = this.db.transaction([CONFIG.STORES.RECORDS], 'readonly'); 
            tx.objectStore(CONFIG.STORES.RECORDS).get('all_records').onsuccess = (e) => { 
                const res = e.target.result || [];
                console.log(`[DB] Loaded ${res.length} records`);
                if(res.length > 0) { this.allRecords = res; this.isLoaded = true; } 
                resolve(res); 
            }; 
        }); 
    }
    static save(data) { const tx = this.db.transaction([CONFIG.STORES.RECORDS], 'readwrite'); tx.objectStore(CONFIG.STORES.RECORDS).put(data, 'all_records'); }
    static async syncCloud(isBackground) { 
        console.log(`[Cloud] Sync Start (Background: ${isBackground})`);
        try { 
            const formula = `NOT(SEARCH("residential", LOWER({${CONFIG.FIELDS.TARGET}} & " " & {${CONFIG.FIELDS.NAME}})))`; 
            let records = [], offset = null; 
            do { 
                let url = `https://api.airtable.com/v0/${CONFIG.MAIN_BASE_ID}/${CONFIG.TABLE_ID}?filterByFormula=${encodeURIComponent(formula)}&fields[]=${encodeURIComponent(CONFIG.FIELDS.TARGET)}&fields[]=${encodeURIComponent(CONFIG.FIELDS.NAME)}&fields[]=${encodeURIComponent(CONFIG.FIELDS.PDF)}`; 
                if (offset) url += `&offset=${offset}`; 
                const resp = await fetch(url, { headers: { 'Authorization': `Bearer ${CONFIG.MAIN_TOKEN}` } }); 
                const data = await resp.json(); 
                records = [...records, ...data.records]; offset = data.offset; 
                console.log(`[Cloud] Page loaded. Total so far: ${records.length}`);
            } while (offset); 
            this.allRecords = records; this.isLoaded = true; this.save(records); UI.enableSearch(true); 
            console.log("[Cloud] Sync Complete");
            if(!isBackground) { const btn = document.getElementById('searchBtn'); btn.disabled = false; btn.querySelector('.search-btn-sub').innerText = "Ready"; } 
        } catch (e) { console.error("Sync Failed", e); } 
    }
    static loadLocalOverride() { setTimeout(() => { if (window.LOCAL_PANEL_DATA) { console.log("[DB] Local Override Applied"); this.processLocalData(window.LOCAL_PANEL_DATA); } }, 1000); }
    static processLocalData(data) { 
        const db = {}; 
        const cleanKey = (k) => k.toString().toUpperCase().replace('CP-','').trim(); 
        const getVal = (obj, keys) => { const found = Object.keys(obj).find(k => keys.includes(k.toLowerCase())); return found ? obj[found] : null; }; 
        const normalizeItem = (item) => { return { mfg: getVal(item, ['mfg','manufacturer']) || 'N/A', hp: getVal(item, ['hp']) || 'N/A', volt: getVal(item, ['volt','vac']) || 'N/A', phase: getVal(item, ['phase','ph']) || 'N/A', enc: getVal(item, ['enclosure','enc']) || 'N/A' }; }; 
        if (Array.isArray(data)) { 
            data.forEach(item => { 
                if (item.id) {
                    let key = cleanKey(item.id);
                    let originalKey = key;
                    let counter = 2;
                    while (db[key]) { key = `${originalKey}-${counter}`; counter++; }
                    db[key] = normalizeItem(item);
                } 
            }); 
        } else { for (const [k, v] of Object.entries(data)) { db[cleanKey(k)] = normalizeItem(v); } } 
        this.masterData = db; 
    }
}
class AIService {
    static stats = { hp: {}, volt: {}, phase: {}, mfg: {}, correlations: [] }; static consensus = {}; static healingMap = {};
    static async init() { 
        console.log("[AI] Init...");
        if (DatabaseService.db) { try { const tx = DatabaseService.db.transaction([CONFIG.STORES.CONSENSUS], 'readonly'); const req = tx.objectStore(CONFIG.STORES.CONSENSUS).getAll(); req.onsuccess = () => { req.result.forEach(item => { this.consensus[`${item.panelKey}_${item.category}`] = item; }); }; } catch(e) { console.warn("Consensus store error", e); } } 
        await this.syncHealingData(); 
        this.train(); 
    }
    static train() { 
        console.log("[AI] Training Probabilistic Model (Naive Bayes)..."); 
        this.stats = { hp: {}, volt: {}, mfg: {}, correlations: [] }; 
        const tally = (store, key) => { store[key] = (store[key] || 0) + 1; }; 
        if(!DatabaseService.allRecords || DatabaseService.allRecords.length === 0) { console.warn("[AI] No records to train on."); return; }
        DatabaseService.allRecords.forEach(rec => { const txt = (rec.fields[CONFIG.FIELDS.TARGET]||'') + ' ' + (rec.fields[CONFIG.FIELDS.NAME]||''); const specs = SearchEngine.extractSpecs(txt); const mfg = SearchEngine.detectMfg(txt); const point = { hp: specs.hp[0] || null, volt: specs.volts[0] || null, mfg: mfg || null, phase: (specs.phaseScores.s3 > specs.phaseScores.s1) ? 3 : ((specs.phaseScores.s1 > specs.phaseScores.s3) ? 1 : null) }; if(point.hp) tally(this.stats.hp, point.hp); if(point.volt) tally(this.stats.volt, point.volt); if(point.mfg) tally(this.stats.mfg, point.mfg); this.stats.correlations.push(point); }); 
        console.log(`[AI] Training Complete. Learned from ${this.stats.correlations.length} patterns.`); 
    }
    static predict(inputs) { if (!this.stats.correlations.length) return null; const targets = ['volt', 'phase', 'enc']; let predictions = {}; targets.forEach(target => { if (inputs[target]) return; const candidates = {}; this.stats.correlations.forEach(record => { let score = 1; if (inputs.hp && record.hp === parseFloat(inputs.hp)) score *= 5; if (inputs.mfg && record.mfg === inputs.mfg) score *= 3; const val = record[target]; if (val) { candidates[val] = (candidates[val] || 0) + score; } }); let bestVal = null; let maxScore = 0; Object.entries(candidates).forEach(([val, score]) => { if (score > maxScore) { maxScore = score; bestVal = val; } }); if (bestVal) predictions[target] = bestVal; }); return predictions; }
    static async syncHealingData() { console.log("[AI] Syncing Healing Data..."); try { let fixes = [], offset = null; do { let url = `https://api.airtable.com/v0/${CONFIG.MARKOV_BASE_ID}/${CONFIG.HEALING_TABLE_ID}`; if(offset) url += `?offset=${offset}`; const r = await fetch(url, { headers: { 'Authorization': `Bearer ${CONFIG.MARKOV_TOKEN}` } }); if(!r.ok) break; const d = await r.json(); if(d.records) fixes = [...fixes, ...d.records]; offset = d.offset; } while(offset); if(DatabaseService.db && fixes.length > 0) { console.log(`[AI] Synced ${fixes.length} healing records from Cloud.`); const tx = DatabaseService.db.transaction([CONFIG.STORES.CONSENSUS], 'readwrite'); fixes.forEach(rec => { const k = rec.fields.Key; if(k) { this.healingMap[k] = rec.id; const item = { panelKey: rec.fields.PanelNum, category: rec.fields.Category, value: rec.fields.Value, count: rec.fields.Count || 1, timestamp: Date.now() }; this.consensus[k] = item; tx.objectStore(CONFIG.STORES.CONSENSUS).put(item, k); } }); } } catch(e) { console.warn("Healing sync skipped (offline)", e); } }
    static async tallyVote(panelKey, category, value) { if(!DatabaseService.db) return; const key = `${panelKey}_${category}`; let item = this.consensus[key] || { panelKey, category, value, count: 0, timestamp: Date.now() }; if (item.value !== value) { item.value = value; item.count = 1; } else { item.count += 1; } item.timestamp = Date.now(); const tx = DatabaseService.db.transaction([CONFIG.STORES.CONSENSUS], 'readwrite'); tx.objectStore(CONFIG.STORES.CONSENSUS).put(item, key); this.consensus[key] = item; console.log(`[AI] Vote recorded for CP-${panelKey} [${category}=${value}]. Confidence: ${item.count}`); this.train(); try { if(this.healingMap[key]) { await fetch(`https://api.airtable.com/v0/${CONFIG.MARKOV_BASE_ID}/${CONFIG.HEALING_TABLE_ID}/${this.healingMap[key]}`, { method: 'PATCH', headers: { 'Authorization': `Bearer ${CONFIG.MARKOV_TOKEN}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ fields: { Value: String(value), Count: item.count } }) }); console.log(`[Cloud] Healing record updated: ${key}`); } else { const r = await fetch(`https://api.airtable.com/v0/${CONFIG.MARKOV_BASE_ID}/${CONFIG.HEALING_TABLE_ID}`, { method: 'POST', headers: { 'Authorization': `Bearer ${CONFIG.MARKOV_TOKEN}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ fields: { Key: key, PanelNum: String(panelKey), Category: String(category), Value: String(value), Count: item.count } }) }); const d = await r.json(); this.healingMap[key]=d.id; console.log(`[Cloud] New Healing record created: ${key}`); } } catch(e) { console.error("[Cloud] Sync Failed:", e); } setTimeout(() => SearchEngine.applyFilter(true), 100); }
    static async saveOverride(pKey, cat, val) { this.tallyVote(pKey, cat, val); }
    static async deleteOverride(key) { /* Logic handled in UI/DB service */ }
}

class SearchEngine {
    static activeFilters = {}; static lastInput = ''; static results = []; static displayList = []; static page = 1; static itemsPerPage = 20; static cachedRegex = {};
    static init() { console.log("[Search] Init Regex..."); Object.entries(CONSTANTS.MANUFACTURERS).forEach(([mfg, aliases]) => { this.cachedRegex[mfg] = aliases.map(a => new RegExp(`\\b${a}\\b`, 'i')); }); }
    static normalize(str) { return str ? str.toString().replace(/[^a-zA-Z0-9]/g, '').toLowerCase() : ''; }
    static escapeRegExp(string) { return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
    static parseHP(str) { 
        if (!str || str === '0') return 0; 
        const s = str.toString(); 
        if(s.includes('/') && !s.includes('-')) {
            const p = s.split('/'); 
            return parseFloat(p[0]) / parseFloat(p[1]);
        }
        const c = s.match(/(\d+)[-\s]+(\d+)\/(\d+)/); 
        if (c) return parseFloat(c[1]) + (parseFloat(c[2]) / parseFloat(c[3])); 
        return parseFloat(s.replace(/,/g, '')); 
    }
    static detectMfg(text) { for (const [mfg, regexList] of Object.entries(this.cachedRegex)) { for (const regex of regexList) { if (regex.test(text)) return mfg.toUpperCase(); } } return ""; }
    
    static extractSpecs(text) { 
        let clean = text.replace(/(\r\n|\n|\r)/gm, " "); 
        const specs = { hp: [], volts: [], phase: [], enclosure: [], phaseScores: { s1: 0, s3: 0 }, isMulti: false }; 
        const hpRe1 = /\b(\d+(?:\.\d+)?)\s*[-]?\s*hp\b/gi;
        let m; 
        while((m=hpRe1.exec(clean))!==null) { specs.hp.push(SearchEngine.parseHP(m[1])); }
        const hpRe2 = /\bhp\s*[:.]?\s*(\d+(?:\.\d+)?)\b/gi;
        while((m=hpRe2.exec(clean))!==null) { specs.hp.push(SearchEngine.parseHP(m[1])); }
        const voltRe = /\b(\d+(?:\/\d+)?)\s*[-]?\s*(?:v|vac|volts)\b/gi; 
        while((m=voltRe.exec(clean))!==null) { if(!clean.substring(m.index-20, m.index).toLowerCase().includes('control')) specs.volts.push(parseInt(m[1])); } 
        if(/\b(3|three)\s*[-]?\s*(ph(ase)?|√∏)\b/gi.test(clean)) specs.phase.push(3);
        if(/\b(1|single)\s*[-]?\s*(ph(ase)?|√∏)\b/gi.test(clean)) specs.phase.push(1);
        if(/nema\s*4x/i.test(clean)) {
            if(/stainless|ss/i.test(clean)) specs.enclosure.push("NEMA 4X Stainless");
            else if(/fiberglass|fg/i.test(clean)) specs.enclosure.push("NEMA 4X Fiberglass");
            else specs.enclosure.push("NEMA 4X");
        }
        if(/poly/i.test(clean)) specs.enclosure.push("Poly");
        specs.hp = [...new Set(specs.hp)];
        specs.phase = [...new Set(specs.phase)];
        specs.enclosure = [...new Set(specs.enclosure)];
        return specs; 
    }

    static perform() { 
        const mfg = document.getElementById('mfgInput').value; 
        const kw = document.getElementById('keywordInput').value.trim(); 
        const hp = document.getElementById('hpInput').value; 
        const volt = document.getElementById('voltInput').value; 
        const phase = document.getElementById('phaseInput').value; 
        const enc = document.getElementById('enclosureInput').value; 
        const keys = kw.split(',').map(k => k.trim()).filter(k => k.length > 0);
        this.process({ mfg, hp, volt, phase, enclosure: enc, keys: keys, partNumbers: [] }); 
        this.applyFilter(false); 
    }

    static process(inputs) { 
        const likely = AIService.predict(inputs); 
        const scored = DatabaseService.allRecords.map(rec => { 
            let txt = (rec.fields[CONFIG.FIELDS.TARGET]||'') + ' ' + (rec.fields[CONFIG.FIELDS.NAME]||''); 
            let txtL = txt.toLowerCase(); 
            const pMatch = (rec.fields[CONFIG.FIELDS.NAME]||'').match(CONSTANTS.REGEX.PANEL_NUM); 
            const pNum = pMatch ? pMatch[1] : '0'; 
            const cName = pMatch ? `CP-${pNum}` : (rec.fields[CONFIG.FIELDS.NAME]||'').trim(); 
            const hasPdf = rec.fields[CONFIG.FIELDS.PDF] && rec.fields[CONFIG.FIELDS.PDF].length > 0; 
            let fTxt = txtL; 
            if(pNum!=='0' && DatabaseService.masterData[pNum]) { 
                const md = DatabaseService.masterData[pNum]; 
                if(md.mfg) fTxt += ` ${md.mfg.toLowerCase()}`; 
                if(md.hp) fTxt += ` ${md.hp}hp`; 
                if(md.phase && md.phase !== 'N/A') fTxt += ` ${md.phase}ph`; 
                if(md.enc && md.enc !== 'N/A') fTxt += ` ${md.enc.toLowerCase()}`; 
            } 
            const specs = this.extractSpecs(fTxt); 
            let final = { hp: specs.hp, volts: specs.volts, phase: specs.phase, enclosure: specs.enclosure }; 
            let hud = []; 
            let pScore = 0; 
            let conflict = 0; 
            let totalMatches = 0; 
            let matchWeight = 0;
            let finalMfg = SearchEngine.detectMfg(fTxt); 

            if (inputs.keys && inputs.keys.length > 0) {
                inputs.keys.forEach(k => {
                    if (!k) return;
                    const kw = k.toLowerCase().trim();
                    if (!kw) return;
                    if (fTxt.includes(kw)) {
                        matchWeight += 3000; 
                        totalMatches++;
                        hud.push({label: `"${k}"`, status: 'match'});
                    } else {
                        conflict++; 
                        hud.push({label: `"${k}"`, status: 'conflict'});
                    }
                });
            }

            if(inputs.mfg) { 
                const isMatch = finalMfg === inputs.mfg.toUpperCase(); 
                let status = 'neutral'; 
                if (isMatch) { status = 'match'; matchWeight += 1000; totalMatches++; } 
                else if (finalMfg === "") status = 'neutral'; 
                else { status = 'conflict'; conflict++; } 
                hud.push({label: inputs.mfg, status: status}); 
            } 
            if(inputs.volt) { 
                const v = parseInt(inputs.volt); 
                const isMatch = final.volts.includes(v); 
                if(isMatch) { matchWeight += 2000; totalMatches++; hud.push({label: v+'V', status: 'match'}); }
                else if (final.volts.length > 0) { conflict++; hud.push({label: v+'V', status: 'conflict'}); }
                else hud.push({label: v+'V', status: 'neutral'});
            } 
            if(inputs.hp) { 
                const h = parseFloat(inputs.hp); 
                let status = 'neutral';
                if (final.hp.includes(h)) { status = 'match'; matchWeight += 500; totalMatches++; }
                else if (final.hp.length > 1) { 
                    const closest = final.hp.reduce((prev, curr) => Math.abs(curr - h) < Math.abs(prev - h) ? curr : prev);
                    if (Math.abs(closest - h) <= 5) { status = 'varies'; matchWeight += 200; }
                } 
                hud.push({label: h+'HP', status: status}); 
            }
            if(inputs.phase) {
                const p = parseInt(inputs.phase);
                if (final.phase.includes(p)) { matchWeight += 1500; totalMatches++; hud.push({label: p+'PH', status: 'match'}); }
                else if (final.phase.length > 0) { conflict++; hud.push({label: p+'PH', status: 'conflict'}); }
                else hud.push({label: p+'PH', status: 'neutral'});
            }
            if(inputs.enclosure) {
                const e = inputs.enclosure;
                const match = final.enclosure.find(enc => enc.toLowerCase().includes(e.toLowerCase()) || e.toLowerCase().includes(enc.toLowerCase()));
                if (match) { matchWeight += 1000; totalMatches++; hud.push({label: e, status: 'match'}); }
                else if (final.enclosure.length > 0) { conflict++; hud.push({label: e, status: 'conflict'}); }
                else hud.push({label: e, status: 'neutral'});
            }

            if(likely && likely.volt && final.volts.includes(parseInt(likely.volt))) { pScore += 50; } 
            
            let tier = 1; 
            if (conflict === 0 && totalMatches > 0) tier = 4; 
            else if (conflict === 0) tier = 3; 
            else tier = 1; 

            const compositeScore = (tier * 10000) + matchWeight + pScore;
            return { ...rec, hud, tier, pScore, compositeScore, hasPdf, cName, panelNum: pNum, panelKey: pNum, finalMfg, foundHP: final.hp[0] }; 
        }); 
        this.results = scored; 
    }
    static applyFilter(keepScroll) { UI.renderResults(keepScroll); }
}

class UI {
    static sessionVotes = new Set();
    static sessionCorrections = new Set(); 

    static toggleDarkMode() { document.body.classList.toggle('dark-mode'); localStorage.setItem('cox_theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light'); }
    static toggleDemoMode() { /* ... */ }
    static toggleTuner() { document.getElementById('tuner-panel').classList.toggle('open'); }
    static showLoading() { document.getElementById('results-area').innerHTML = '<div>Loading...</div>'; }
    static toggleSearchUI(expand) { if(expand) document.querySelector('.sidebar-controls').classList.remove('collapsed'); else document.querySelector('.sidebar-controls').classList.add('collapsed'); }
    static handleEnter(e) { if(e.key==='Enter') SearchEngine.perform(); }
    static enableSearch(e) { 
        const btn = document.getElementById('searchBtn'); btn.disabled = !e; 
        if(e) btn.querySelector('.search-btn-sub').innerText = "Ready"; 
        document.querySelectorAll('.cox-input').forEach(el => el.disabled = !e); 
        document.querySelectorAll('.reset-btn').forEach(el => el.disabled = !e); 
    }
    static resetSearch() { document.getElementById('keywordInput').value=''; UI.populateDropdown(); document.getElementById('results-area').innerHTML=''; }
    static populateDropdown() { 
        ['mfg', 'hp', 'volt', 'enclosure', 'phase'].forEach(cat => { 
            const select = document.getElementById(`${cat}Input`); 
            if(!select) return; 
            const val = select.value; 
            select.innerHTML = '<option value="">Any</option>'; 
            let items = []; 
            if (cat === 'mfg') items = Object.keys(CONSTANTS.MANUFACTURERS); 
            else if(CONSTANTS.DATA[cat.toUpperCase()]) items = CONSTANTS.DATA[cat.toUpperCase()]; 
            const vocab = VocabService.get(cat).map(v => v.value); 
            // FIX: Normalize to UpperCase before deduping
            let merged = [...items, ...vocab].map(x => String(x).toUpperCase()); 
            merged = [...new Set(merged)]; 
            merged.sort((a,b) => { if(!isNaN(a) && !isNaN(b)) return parseFloat(a) - parseFloat(b); return a.localeCompare(b); }); 
            merged.forEach(i => { const opt = document.createElement('option'); opt.value = i; opt.innerText = i; select.appendChild(opt); }); 
            if(val) select.value = val; 
        }); 
    }
    static renderResults(keepScroll) { 
        const area = document.getElementById('results-area'); area.innerHTML = ''; 
        SearchEngine.results.sort((a,b) => { 
            if (b.compositeScore !== a.compositeScore) return b.compositeScore - a.compositeScore;
            const numA = parseInt(a.panelNum) || 0; 
            const numB = parseInt(b.panelNum) || 0; 
            return numB - numA; 
        }); 
        
        const filter = document.getElementById('resultFilter').value;
        let displayList = SearchEngine.results;
        
        if (filter === 'EXACT') displayList = displayList.filter(r => r.tier === 4);
        else if (filter === 'VARIABLE') displayList = displayList.filter(r => r.tier === 3);
        else if (filter === 'MISMATCH') displayList = displayList.filter(r => r.tier === 1);
        else displayList = displayList.filter(r => r.tier > 1); 

        displayList.slice(0, 20).forEach(r => { 
            const card = document.createElement('div'); 
            card.className = `record-card ${r.tier === 1 ? 'low-score' : ''} ${r.hasPdf?'has-pdf':''}`; 
            if(r.hasPdf) card.onclick = (e) => { if(!e.target.closest('button')) UI.selectCard(card, r); }; 
            let badges = ''; 
            r.hud.forEach(h => badges += `<span class="hud-badge ${h.status}">${h.label}</span>`); 
            
            const mfgLabel = r.finalMfg || 'CONTROL PANEL'; 
            const isVoted = (UI.sessionVotes && UI.sessionVotes.has(r.panelKey));
            const voteBtnClass = isVoted ? 'btn-rl btn-match disabled' : 'btn-rl btn-match';
            const voteBtnDisabled = isVoted ? 'disabled' : '';
            const voteBtnStyle = isVoted ? 'opacity:0.5;cursor:default;' : '';
            
            card.innerHTML = `<div class="panel-label">${mfgLabel}</div><div class="panel-name">${r.cName}</div><div class="hud-row">${badges}</div><div class="rl-actions"><button class="${voteBtnClass}" ${voteBtnDisabled} style="${voteBtnStyle}" onclick="UI.vote('${r.panelKey}', 'overall', 'match', this)">üëç</button><button class="btn-rl btn-mismatch" onclick="UI.openFeedback('${r.panelKey}', '${r.cName}')">üëé</button></div>`; 
            area.appendChild(card); 
        }); 
    }
    static selectCard(card, r) { document.querySelectorAll('.record-card').forEach(c => c.classList.remove('active-view')); card.classList.add('active-view'); if(window.innerWidth < 900) document.getElementById('preview-pane').classList.add('active'); PdfController.load(r.fields[CONFIG.FIELDS.PDF][0].url); }
    static closePdf() { document.getElementById('preview-pane').classList.remove('active'); }
    
    static vote(pKey, pName, type, btn) { 
        if(!UI.sessionVotes) UI.sessionVotes = new Set();
        if(UI.sessionVotes.has(pKey)) return; 
        UI.sessionVotes.add(pKey);
        AIService.tallyVote(pKey, 'overall', 'match'); 
        btn.innerHTML = "‚úì"; 
        btn.classList.add('learned');
        btn.disabled = true;
        btn.style.opacity = '0.5';
        btn.style.cursor = 'default';
    }
    
    static currentFeedbackTarget = null;

    static openFeedback(pKey, pName) { 
        try {
            this.currentFeedbackTarget = { pKey, pName }; 
            if (!this.currentFeedbackTarget.corrected) this.currentFeedbackTarget.corrected = new Set();
            this.renderFeedbackButtons();
            document.getElementById('feedback-modal').classList.add('active'); 
        } catch(e) { console.error("Feedback Modal Error:", e); }
    }
    
    static renderFeedbackButtons() {
        const pKey = this.currentFeedbackTarget.pKey;
        const corrected = UI.sessionCorrections; 
        const getBtn = (cat, label, icon) => {
            const isDone = corrected.has(`${pKey}_${cat}`);
            const disabled = isDone ? 'disabled' : '';
            const style = isDone ? 'background:#e0e0e0; color:#888; border-color:#ccc;' : '';
            const status = isDone ? '‚úì' : icon;
            return `<button class="reason-btn" ${disabled} style="${style}" onclick="UI.submitCorrection('${cat}')"><span>${label}</span><span>${status}</span></button>`;
        };
        const content = document.getElementById('modal-content'); 
        content.innerHTML = `
            <div style="font-size:12px; color:var(--text-secondary); margin-bottom:15px;">${this.currentFeedbackTarget.pName} - Select parameter to fix:</div>
            <div class="feedback-grid">
                ${getBtn('hp', 'HP / Motor', '‚öô')}
                ${getBtn('volt', 'Voltage', '‚ö°')}
                ${getBtn('phase', 'Phase', '„Ä∞')}
                ${getBtn('enclosure', 'Enclosure', 'üì¶')}
                ${getBtn('mfg', 'Manufacturer', 'üè≠')}
                ${getBtn('keyword', 'Keyword', 'üî§')} ${getBtn('other', 'Other / Bad Scan', '‚ö†')}
            </div>
            <div id="correction-detail" style="display:none; margin-top:15px; border-top:1px solid var(--border-color); padding-top:15px;"></div>
        `;
    }
    
    static closeFeedbackModal() { document.getElementById('feedback-modal').classList.remove('active'); this.currentFeedbackTarget = null; }
    
    static submitCorrection(cat) { 
        const detail = document.getElementById('correction-detail'); 
        detail.style.display = 'flex'; 
        detail.style.flexDirection = 'column'; 
        
        let label = cat.toUpperCase(); 
        if(cat==='mfg') label = "MANUFACTURER"; 
        
        // --- NEW KEYWORD LOGIC ---
        if (cat === 'keyword') {
            const rawKw = document.getElementById('keywordInput').value.trim();
            const currentKeywords = rawKw.split(',').map(k => k.trim()).filter(k => k.length > 0);

            if (currentKeywords.length === 0) {
                 detail.innerHTML = `<div style="color:var(--text-secondary); font-size:12px;">No keywords were used in this search.</div><button class="undo-btn" style="margin-top:10px;" onclick="UI.renderFeedbackButtons()">BACK</button>`;
                 return;
            }

            let optionsHtml = '';
            currentKeywords.forEach(k => {
                optionsHtml += `<option value="${k}">${k}</option>`;
            });

            detail.innerHTML = `
                <div style="font-size:11px; font-weight:700; color:var(--app-primary); margin-bottom:5px; text-transform:uppercase;">Flag Incorrect Keyword:</div>
                <select id="correction-val" class="cox-input" style="margin-bottom:10px;">
                    ${optionsHtml}
                </select>
                <div style="display:flex; gap:8px;">
                    <button class="submit-feedback-btn" onclick="UI.finalizeCorrection('${cat}')">FLAG AS BAD</button>
                    <button class="undo-btn" onclick="UI.renderFeedbackButtons()">BACK</button>
                </div>
            `;
            return;
        }
        // -------------------------

        const listId = `list-${cat}-${Date.now()}`; 
        let dataListHtml = `<datalist id="${listId}">`; 
        let vocab = VocabService.get(cat).map(v => v.value); 
        if(CONSTANTS.DATA[cat.toUpperCase()]) vocab = [...CONSTANTS.DATA[cat.toUpperCase()], ...vocab]; 
        vocab = [...new Set(vocab)].sort(); 
        vocab.forEach(v => dataListHtml += `<option value="${v}">`); 
        dataListHtml += `</datalist>`; 
        
        detail.innerHTML = `
            <div style="font-size:11px; font-weight:700; color:var(--app-primary); margin-bottom:5px; text-transform:uppercase;">Correct ${label}:</div>
            <input type="text" id="correction-val" class="cox-input" list="${listId}" placeholder="Select or type value..." style="margin-bottom:10px;" onkeyup="if(event.key==='Enter') UI.finalizeCorrection('${cat}')">
            ${dataListHtml}
            <div style="display:flex; gap:8px;">
                <button class="submit-feedback-btn" onclick="UI.finalizeCorrection('${cat}')">SUBMIT</button>
                <button class="undo-btn" onclick="UI.renderFeedbackButtons()">BACK</button>
            </div>
        `; 
        document.getElementById('correction-val').focus(); 
    }
    
    static finalizeCorrection(cat) { 
        const val = document.getElementById('correction-val').value; 
        if(!val) return; 
        
        if (cat !== 'keyword') {
            VocabService.add(cat, val); 
        }
        
        // If keyword, we treat it as a 'keyword_reject' vote internally or just tally it as 'keyword' with the negative value
        // For simplicity, we stick to the tallyVote structure.
        AIService.saveOverride(this.currentFeedbackTarget.pKey, cat, val); 
        
        UI.sessionCorrections.add(`${this.currentFeedbackTarget.pKey}_${cat}`);
        SearchEngine.applyFilter(true); 
        this.renderFeedbackButtons();
    }

    static toggleGovModal() { const m = document.getElementById('governance-modal'); const isActive = m.classList.contains('active'); if(isActive) this.closeGovModal(); else { m.classList.add('active'); this.renderGovLog(); } }
    static closeGovModal() { document.getElementById('governance-modal').classList.remove('active'); }
    static renderGovLog() { const list = document.getElementById('gov-list'); list.innerHTML = ''; const allRecords = DatabaseService.allRecords.length; const healedCount = Object.keys(AIService.consensus).length; document.getElementById('stat-total').innerText = allRecords; document.getElementById('stat-healed').innerText = healedCount; if(healedCount === 0) { list.innerHTML = '<div style="padding:20px; text-align:center; color:var(--text-secondary);">No AI interventions recorded yet.</div>'; return; } Object.values(AIService.consensus).sort((a,b) => b.timestamp - a.timestamp).forEach(item => { const div = document.createElement('div'); div.className = 'gov-item'; div.innerHTML = `<div class="gov-info"><span class="gov-panel">CP-${item.panelKey}</span><span class="gov-detail">Corrected ${item.category.toUpperCase()} to "<strong>${item.value}</strong>"</span></div><button class="gov-action" onclick="AIService.deleteOverride('${item.panelKey}_${item.category}'); UI.renderGovLog();">REVERT</button>`; list.appendChild(div); }); }
}

class PdfController {
    static activePdf = null; static scale = 1.5; static pdfDoc = null;
    static async load(url) { const container = document.getElementById('pdf-render-container'); container.innerHTML = '<div style="color:white; margin-top:50px;">Loading PDF...</div>'; document.getElementById('preview-placeholder').style.display = 'none'; try { const loadingTask = pdfjsLib.getDocument(url); this.pdfDoc = await loadingTask.promise; container.innerHTML = ''; for (let i = 1; i <= this.pdfDoc.numPages; i++) { await this.renderPage(i, container); } this.activePdf = true; } catch(e) { container.innerHTML = '<div style="color:#ffaaaa; margin-top:50px;">Error Loading PDF</div>'; console.error(e); } }
    static async renderPage(num, container) { try { const page = await this.pdfDoc.getPage(num); const viewport = page.getViewport({scale: this.scale}); const wrapper = document.createElement('div'); wrapper.className = 'page-container'; wrapper.style.width = `${viewport.width}px`; wrapper.style.height = `${viewport.height}px`; wrapper.style.marginBottom = '20px'; const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); canvas.height = viewport.height; canvas.width = viewport.width; canvas.className = 'pdf-canvas'; const renderContext = { canvasContext: ctx, viewport: viewport }; await page.render(renderContext).promise; if(num === 1) this.drawRedactions(ctx, viewport.width, viewport.height); wrapper.appendChild(canvas); const pageNum = document.createElement('div'); pageNum.innerText = `Page ${num}`; pageNum.style.textAlign = 'center'; pageNum.style.color = '#aaa'; pageNum.style.fontSize = '12px'; pageNum.style.marginBottom = '5px'; container.appendChild(pageNum); container.appendChild(wrapper); } catch(e) { console.error(e); } }
    static updateRedactions() { /* Safe Mode: Skipping live re-render */ }
    static drawRedactions(ctx, w, h) { const demoContainer = document.getElementById('demo-inputs-container'); if(demoContainer.style.display === 'none' || !demoContainer.style.display) return; const zones = JSON.parse(localStorage.getItem(STORAGE_KEYS.ZONES)) || this.getDefaultZones(); if(document.getElementById('demoCustomerInput').value) this.fillZone(ctx, zones[0], w, h, document.getElementById('demoCustomerInput').value); if(document.getElementById('demoJobInput').value) this.fillZone(ctx, zones[1], w, h, document.getElementById('demoJobInput').value); if(document.getElementById('demoStageInput').value) this.fillZone(ctx, zones[2], w, h, document.getElementById('demoStageInput').value); if(document.getElementById('demoDateInput').value) this.fillZone(ctx, zones[3], w, h, document.getElementById('demoDateInput').value); }
    static fillZone(ctx, zone, w, h, text) { const x = zone.x * w; const y = zone.y * h; const zw = zone.w * w; const zh = zone.h * h; ctx.fillStyle = "#ffffff"; ctx.fillRect(x, y, zw, zh); ctx.strokeStyle = "#cccccc"; ctx.lineWidth = 1; ctx.strokeRect(x, y, zw, zh); ctx.fillStyle = "#461D7C"; ctx.font = "bold 14px Arial"; ctx.fillText(text, x + 5, y + zh/2 + 5); }
    static getDefaultZones() { return [ { id: 1, label: "Client", x: 0.7, y: 0.88, w: 0.25, h: 0.04 }, { id: 2, label: "Job", x: 0.7, y: 0.92, w: 0.25, h: 0.04 }, { id: 3, label: "Stage", x: 0.4, y: 0.9, w: 0.15, h: 0.05 }, { id: 4, label: "Date", x: 0.85, y: 0.02, w: 0.1, h: 0.03 } ]; }
    static renderTuner() {}
    static addZone() {} 
}

class App {
    static init() {
        console.log("App Initializing...");
        VocabService.init(); 
        BugController.init();
        if (!AuthService.init()) return;
        App.loadData();
    }
    static loadData() {
        console.log("[App] Loading Data Sequence...");
        SearchEngine.init();
        DatabaseService.init().then(async () => {
            const localData = await DatabaseService.load();
            DatabaseService.loadLocalOverride();
            if(localData && localData.length > 0) {
                try { await AIService.init(); } catch(e) { console.error("AI Init Failed", e); }
            } else {
                console.warn("[App] Local DB Empty. Skipping AI Training. Waiting for Cloud Sync.");
            }
            const isFreshStart = (!localData || localData.length === 0);
            if(!isFreshStart) {
                console.log("[App] Data exists, unlocking UI immediately.");
                UI.enableSearch(true);
            }
            document.getElementById('crash-screen').style.display = 'none';
            setTimeout(() => {
                DatabaseService.syncCloud(!isFreshStart);
                if(document.getElementById('crash-screen')) document.getElementById('crash-screen').style.display = 'none';
            }, 500);
            UI.populateDropdown();
        }).catch(e => {
             console.error("[App] FATAL INIT FAILURE", e);
             document.getElementById('crash-screen').style.display = 'flex';
             document.getElementById('error-msg').innerText = "Init Failed: " + (e.message || e) + "\n" + (e.stack || "");
        });
    }
}

document.addEventListener('DOMContentLoaded', App.init);
</script>
</body>
</html>