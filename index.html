<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Cox Research | SCHEMATICai (v22.9)</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîí</text></svg>">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    
    <style>
        /* --- 1. COLOR SYSTEM --- */
        :root { 
            --app-primary: #461D7C;
            --app-accent: #461D7C;
            --bg-app: #e3e5e8; 
            --bg-sidebar: #ffffff; 
            --bg-card: #ffffff;
            --bg-controls: rgba(255,255,255,0.98); 
            --bg-viewer: #525659;
            --bg-input: #ffffff;
            --text-primary: #121212; 
            --text-secondary: #5f6368; 
            --border-color: #c7c7cc; 
            
            /* BADGE COLORS */
            --match-green-bg: #dcfce7; --match-green-text: #166534; 
            --match-orange-bg: #ffedd5; --match-orange-text: #9a3412; 
            --match-red-bg: #fee2e2; --match-red-text: #991b1b; 
            --match-keyword-bg: #dcfce7; --match-keyword-text: #166534;
            
            /* HEADER & SAFE AREA VARS */
            --header-base-height: 55px; 
            --input-height: 36px;
            color-scheme: light; 
        }

        body.dark-mode {
            --app-primary: #A78BFA;
            --app-accent: #8B5CF6;
            --bg-app: #0F0F0F;
            --bg-sidebar: #18181B;
            --bg-card: #27272A;
            --bg-controls: rgba(24, 24, 27, 0.98); 
            --bg-viewer: #1a1a1a; 
            --bg-input: #3F3F46; 
            --text-primary: #F4F4F5; 
            --text-secondary: #A1A1AA; 
            --border-color: #3F3F46;
            
            --match-green-bg: #064E3B; --match-green-text: #6EE7B7;
            --match-orange-bg: #7C2D12; --match-orange-text: #FDBA74;
            --match-red-bg: #7f1d1d; --match-red-text: #fca5a5;
            --match-keyword-bg: #064E3B; --match-keyword-text: #6EE7B7;
            
            color-scheme: dark;            
        }
        
        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; background-color: var(--bg-app); color: var(--text-primary); height: 100vh; display: flex; flex-direction: column; overflow: hidden; font-size: 13px; }

        /* --- HEADER (iOS SAFE AREA) --- */
        header { 
            background: linear-gradient(135deg, #461D7C 0%, #2e0e57 100%); 
            padding: 10px 15px;
            padding-top: max(10px, env(safe-area-inset-top)); 
            height: auto;
            min-height: var(--header-base-height);
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); 
            z-index: 100; 
            flex-shrink: 0; 
            position: relative; 
        }

        .logo-group { text-decoration: none; display: flex; flex-direction: column; line-height: 1; z-index: 2; }
        .logo-main { font-family: 'Helvetica Neue', Arial, sans-serif; font-size: 1.4rem; font-weight: 900; color: white; letter-spacing: -1px; text-transform: uppercase; }
        .logo-sub { font-family: 'Helvetica Neue', Arial, sans-serif; font-size: 0.5rem; color: #b39ddb; font-weight: 700; letter-spacing: 3px; text-transform: uppercase; margin-top: 2px; }
        .version-badge { position: absolute; left: 50%; top: 55%; transform: translate(-50%, -50%); background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.3); color: white; padding: 3px 10px; border-radius: 20px; font-weight: 800; font-size: 11px; letter-spacing: 1px; white-space: nowrap; pointer-events: none; }
        .header-controls { display: flex; align-items: center; gap: 8px; margin-left: auto; z-index: 2; }
        .control-btn { background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.3); color: white; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 15px; transition: all 0.2s; overflow: hidden; }

        /* --- MAIN LAYOUT --- */
        #app-container { display: none; flex: 1; overflow: hidden; position: relative; }
        html.logged-in #app-container { display: flex !important; }
        
        #sidebar { width: 320px; min-width: 280px; background: var(--bg-sidebar); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; z-index: 20; transition: transform 0.3s ease; }
        
        /* COLLAPSIBLE CONTROLS */
        .sidebar-controls { padding: 8px; background: var(--bg-controls); border-bottom: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 5px; transition: all 0.3s ease; overflow: hidden; max-height: 500px; opacity: 1; }
        .sidebar-controls.collapsed { max-height: 0; padding: 0; opacity: 0; border-bottom: none; }
        
        #refine-btn-area { display: none; padding: 6px; background: var(--bg-controls); border-bottom: 1px solid var(--border-color); text-align: center; }
        #refine-btn-area.visible { display: block; }
        
        #preview-pane { flex: 1; background: var(--bg-viewer); display: flex; flex-direction: column; color: rgba(255,255,255,0.5); font-size: 20px; position:relative; overflow: hidden; }
        
        /* PDF TOOLBAR */
        #pdf-toolbar { display: none; height: 45px; background: #2a2a2a; border-bottom: 1px solid #444; align-items: center; justify-content: center; gap: 15px; flex-shrink: 0; width: 100%; }
        .pdf-tool-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; width: 30px; height: 30px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; transition: 0.2s; }
        .pdf-tool-btn:hover { background: rgba(255,255,255,0.2); }
        #pdf-zoom-level { color: white; font-size: 12px; font-weight: 600; min-width: 40px; text-align: center; }

        /* CUSTOM VIEWER */
        #custom-pdf-viewer { display: flex; width: 100%; height: 100%; flex-direction: row; }
        #pdf-sidebar { width: 240px; background: #2a2a2a; border-right: 1px solid #444; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; padding: 10px; flex-shrink: 0; }
        
        /* MOBILE OVERRIDE: STACK LAYOUT */
        #pdf-main-view { flex: 1; overflow: auto; display: flex; flex-direction: column; align-items: center; padding: 20px; background: var(--bg-viewer); gap: 20px; }
        
        .pdf-page-container { position: relative; box-shadow: 0 4px 15px rgba(0,0,0,0.5); background: white; }
        .pdf-page-canvas { display: block; }
        
        .pdf-thumb-wrapper { cursor: pointer; position: relative; border: 2px solid transparent; transition: 0.1s; }
        .pdf-thumb-wrapper.active { border-color: var(--app-accent); }
        .pdf-thumb-canvas { width: 100% !important; height: auto !important; display: block; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        .pdf-page-num { position: absolute; bottom: 2px; right: 2px; background: rgba(0,0,0,0.7); color: white; padding: 2px 6px; font-size: 10px; border-radius: 4px; pointer-events: none; }
        
        #pdf-placeholder-text { display: flex; align-items: center; justify-content: center; height: 100%; width: 100%; color: rgba(255,255,255,0.3); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }

        /* FILTERS */
        .filter-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; }
        .input-group.full-width { grid-column: span 2; }
        .input-group { display: flex; flex-direction: column; gap: 1px; }
        .input-label { font-size: 9px; font-weight: 800; text-transform: uppercase; color: var(--text-secondary); }
        .cox-input { width: 100%; height: var(--input-height); padding: 0 8px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 12px; background: var(--bg-input); color: var(--text-primary); outline: none; }
        
        .search-btn { flex: 1; height: 34px; background-color: var(--app-accent) !important; color: white !important; border: none; border-radius: 4px; font-weight: 800; cursor: pointer; transition: 0.3s; font-size: 12px; letter-spacing: 0.5px; }
        .search-btn:disabled { background-color: #9ca3af !important; cursor: not-allowed; opacity: 0.7; }
        .search-btn.warning { background-color: #f59e0b !important; color: black !important; }
        .reset-btn { height: 34px; width: 34px; background: var(--bg-app); border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer; }
        .refine-btn { width: 100%; height: 28px; background: var(--bg-input); border: 1px solid var(--app-accent); color: var(--app-accent); border-radius: 4px; font-weight: 700; cursor: pointer; font-size: 11px; }

        #results-scroll-area { flex: 1; overflow-y: auto; padding: 6px; background: var(--bg-app); }
        #results-area { display: flex; flex-direction: column; gap: 3px; padding-bottom: 80px; }

        /* RECORD CARD */
        .record-card { background: var(--bg-card); padding: 5px 8px; border-radius: 4px; border: 1px solid var(--border-color); border-left: 4px solid var(--app-primary); box-shadow: 0 1px 2px rgba(0,0,0,0.05); cursor: pointer; position: relative; transition: all 0.2s; display: flex; flex-direction: column; gap: 2px; }
        .record-card:hover { transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .record-card.active-view { background: rgba(139, 92, 246, 0.1); border-color: var(--app-accent); }
        .record-card.varied-result { opacity: 0.9; border-left-color: #94a3b8; }
        
        .panel-name { font-size: 14px; font-weight: 800; color: var(--app-primary); margin: 0; letter-spacing: -0.3px; line-height: 1.1; }

        .badge-row { display: flex; gap: 2px; flex-wrap: wrap; }
        .hud-badge { font-size: 9px; font-weight: 800; text-transform: uppercase; padding: 1px 4px; border-radius: 3px; letter-spacing: 0.3px; border: 1px solid transparent; }
        .hud-badge.match-green { background: var(--match-green-bg); color: var(--match-green-text); }
        .hud-badge.match-orange { background: var(--match-orange-bg); color: var(--match-orange-text); }
        .hud-badge.match-red { background: var(--match-red-bg); color: var(--match-red-text); }
        .hud-badge.match-keyword { background: var(--match-keyword-bg); color: var(--match-keyword-text); }

        .card-actions { display: flex; gap: 4px; justify-content: flex-end; margin-top: 1px; border-top: 1px solid var(--border-color); padding-top: 2px; }
        .thumb-btn { background: transparent; border: 1px solid var(--border-color); border-radius: 3px; width: 22px; height: 22px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; transition: 0.2s; }
        .thumb-btn.voted-up { background: #dcfce7 !important; border-color: #166534 !important; color: #166534 !important; opacity: 1 !important; pointer-events: none; cursor: default; }
        
        #pdf-viewer-frame { width: 100%; height: 100%; border: none; background: #fff; }
        .pdf-fallback { display: none; text-align: center; color: white; padding: 20px; width: 100%; align-self: center; }
        
        #mobile-back-btn { display: none; position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--app-accent); color: white; padding: 10px 20px; border-radius: 25px; border: none; font-weight: 800; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 50; cursor: pointer; }

        @media (min-width: 768px) and (max-width: 1024px) {
            #sidebar { width: 260px; min-width: 260px; } 
            .logo-main { font-size: 1.2rem; }
        }
        @media (max-width: 767px) {
            .version-badge { display: none; } 
            .header-controls { gap: 6px; }
            #sidebar { width: 100%; height: 100%; border-right: none; }
            #preview-pane { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; opacity: 0; pointer-events: none; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
            body.viewing-pdf #preview-pane { opacity: 1; pointer-events: auto; transform: translateX(0); }
            body.viewing-pdf #mobile-back-btn { display: block; }
            #pdf-sidebar { display: none; } 
        }

        #auth-overlay, #feedback-modal, #config-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(4px); z-index: 10000; align-items: center; justify-content: center; overflow-y: auto; }
        .active-modal { display: flex !important; }
        .auth-card, .config-card, .modal-card { background: var(--bg-card); padding: 25px; border-radius: 10px; width: 90%; max-width: 380px; text-align: center; border: 1px solid var(--border-color); }
        .auth-group { margin-bottom: 15px; text-align: left; }
        .auth-label { font-size: 10px; font-weight: 800; color: var(--text-secondary); text-transform: uppercase; display: block; margin-bottom: 5px; }
        .submit-feedback-btn { width: 100%; padding: 10px; background: var(--app-accent); color: white; border: none; border-radius: 5px; font-weight: 700; cursor: pointer; margin-top: 12px; }
        .reason-btn { padding: 8px; border: 1px solid var(--border-color); background: var(--bg-input); color: var(--text-primary); border-radius: 5px; cursor: pointer; text-align: center; font-size: 11px; font-weight: 600; margin-bottom:4px; display:block; }
        .reason-btn.selected { background: var(--status-error); color: white; border-color: var(--status-error); }
        .correction-input { display: none; width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; margin-top: 4px; margin-bottom:8px; }
        .reason-btn.selected + .correction-input { display: block; }

    </style>
</head>
<body>

<div id="auth-overlay" class="active-modal">
    <div class="auth-card">
        <div style="font-size:32px;margin-bottom:15px;">üë§</div>
        <h2 style="color:var(--app-primary); margin-top:0;">SCHEMATICai</h2>
        <div class="auth-group">
            <label for="auth-user" class="auth-label">Username</label>
            <input type="text" id="auth-user" class="cox-input" placeholder="Enter Username" autocomplete="username">
        </div>
        <div class="auth-group">
            <label for="auth-pass" class="auth-label">Passcode</label>
            <input type="password" id="auth-pass" class="cox-input" placeholder="Enter Passcode" autocomplete="current-password" onkeypress="if(event.key==='Enter') AuthService.login()">
        </div>
        <button class="submit-feedback-btn" onclick="AuthService.login()">Authenticate</button>
    </div>
</div>

<div id="config-modal">
    <div class="config-card">
        <h3>üõ†Ô∏è Admin Tools</h3>
        <button class="submit-feedback-btn" onclick="DataLoader.harvestCSV()">üì• Harvest CSV</button>
        <button class="submit-feedback-btn" style="background:var(--status-error); margin-top:8px;" onclick="AuthService.logout()">‚èª Logout</button>
        <div style="margin-top:10px;"><button class="submit-feedback-btn" style="background:#555;" onclick="document.getElementById('config-modal').classList.remove('active-modal')">Close</button></div>
    </div>
</div>

<header>
    <a href="#" class="logo-group"><span class="logo-main">COX</span><span class="logo-sub">RESEARCH</span></a>
    <div class="version-badge">SCHEMATICai v22.9</div>
    <div class="header-controls">
        <div id="settings-btn-wrapper"><button class="control-btn" onclick="document.getElementById('config-modal').classList.add('active-modal')">‚öôÔ∏è</button></div>
        <button class="control-btn btn-bug" onclick="FeedbackService.down(null)">üêû</button>
        <button class="control-btn" onclick="UI.toggleDarkMode()">üåì</button>
    </div>
</header>

<div id="feedback-modal">
    <div class="modal-card">
        <h3>Report Inaccuracy</h3>
        <div style="padding:15px; text-align:left;">
             <div class="reason-btn" data-reason="mfg" onclick="FeedbackService.toggleReason(this)">Wrong Manufacturer</div><input type="text" class="correction-input" placeholder="Correct Value">
             <div class="reason-btn" data-reason="hp" onclick="FeedbackService.toggleReason(this)">Wrong HP</div><input type="text" class="correction-input" placeholder="Correct Value">
             <div class="reason-btn" data-reason="volt" onclick="FeedbackService.toggleReason(this)">Wrong Voltage</div><input type="text" class="correction-input" placeholder="Correct Value">
             <div class="reason-btn" data-reason="enc" onclick="FeedbackService.toggleReason(this)">Wrong Enclosure</div><input type="text" class="correction-input" placeholder="Correct Value">
             <div id="dynamic-feedback-container"></div>
             <button class="submit-feedback-btn" onclick="FeedbackService.submit()">SUBMIT & VOTE</button>
             <button class="submit-feedback-btn" style="background:#555;margin-top:5px;" onclick="FeedbackService.close()">CANCEL</button>
        </div>
    </div>
</div>

<div id="app-container">
    <div id="sidebar">
        <div id="search-controls" class="sidebar-controls">
            <div class="input-group"><span class="input-label">Keywords</span><input type="text" id="keywordInput" class="cox-input" placeholder="Separate phrases with commas (e.g. Main Pump, 1PH)" onkeypress="UI.handleEnter(event)"></div>
            
            <div class="filter-grid">
                <div class="input-group"><span class="input-label">Mfg</span><select id="mfgInput" class="cox-input"><option value="Any">Any</option></select></div>
                <div class="input-group"><span class="input-label">HP</span><select id="hpInput" class="cox-input"><option value="Any">Any</option></select></div>
                <div class="input-group"><span class="input-label">Voltage</span><select id="voltInput" class="cox-input"><option value="Any">Any</option></select></div>
                <div class="input-group"><span class="input-label">Phase</span><select id="phaseInput" class="cox-input"><option value="Any">Any</option></select></div>
                <div class="input-group full-width"><span class="input-label">Enclosure</span><select id="encInput" class="cox-input"><option value="Any">Any</option></select></div>
            </div>
            
            <div style="display:flex; gap:8px; margin-top:5px;">
                <button class="reset-btn" onclick="UI.resetSearch()">‚Ü∫</button>
                <button id="searchBtn" class="search-btn" onclick="SearchEngine.perform()" disabled>INITIALIZING...</button>
            </div>
        </div>
        
        <div id="refine-btn-area">
            <button class="refine-btn" onclick="UI.toggleSearch(true)">üîç REFINE SEARCH</button>
        </div>

        <div id="results-scroll-area"><div id="results-area"></div></div>
    </div>
    
    <div id="preview-pane">
        <div id="pdf-toolbar">
            <button class="pdf-tool-btn" onclick="PdfViewer.zoom(-0.2)">-</button>
            <span id="pdf-zoom-level">130%</span>
            <button class="pdf-tool-btn" onclick="PdfViewer.zoom(0.2)">+</button>
            <button class="pdf-tool-btn" style="margin-left:10px;" onclick="PdfViewer.print()">üñ®Ô∏è</button>
        </div>

        <div id="pdf-placeholder-text">üìÑ Select a schematic</div>

        <div id="custom-pdf-viewer" style="display:none;">
            <div id="pdf-sidebar"></div>
            <div id="pdf-main-view"></div>
        </div>
        
        <iframe id="pdf-viewer-frame" style="display:none;"></iframe>
        
        <div id="pdf-fallback" class="pdf-fallback">
            <div style="margin-bottom:10px;">‚ö†Ô∏è PDF Link Not Found</div>
            <a id="pdf-fallback-link" target="_blank">Open File</a>
        </div>
        <button id="mobile-back-btn" onclick="UI.closeMobilePreview()">‚Üê BACK TO RESULTS</button>
    </div>
</div>

<script>
// --- SCHEMATICai v22.9 (PERSISTENT DARK MODE) ---
const WORKER_URL = "https://cox-proxy.thomas-85a.workers.dev"; 
const CONFIG = { mainTable: 'MAIN', feedbackTable: 'FEEDBACK', voteThreshold: 3, estTotal: 7500 };

// --- PDF VIEWER ---
class PdfViewer {
    static doc = null;
    static currentScale = 1.3; 
    static currentPage = 1;
    static url = "";
    static isMobile = false;

    static async load(url) {
        this.url = url;
        this.isMobile = window.innerWidth < 768;
        
        // AUTO-SCALE
        this.currentScale = this.isMobile ? 0.7 : 1.3;

        document.getElementById('pdf-fallback').style.display = 'none';
        document.getElementById('pdf-toolbar').style.display = 'flex'; 
        
        try {
            const loadingTask = pdfjsLib.getDocument(url);
            this.doc = await loadingTask.promise;
            document.getElementById('custom-pdf-viewer').style.display = 'flex';
            document.getElementById('pdf-viewer-frame').style.display = 'none';
            
            if (this.isMobile) {
                this.renderMobileStack();
            } else {
                this.renderSidebar();
                this.renderPage(1, false); 
            }
        } catch (e) {
            console.warn("Custom Viewer Failed, Reverting", e);
            this.loadNative(url);
        }
    }

    static loadNative(url) {
        document.getElementById('custom-pdf-viewer').style.display = 'none';
        document.getElementById('pdf-toolbar').style.display = 'none'; 
        const frame = document.getElementById('pdf-viewer-frame');
        frame.style.display = 'block';
        frame.src = url + "#view=FitH";
    }

    static async renderSidebar() {
        const sidebar = document.getElementById('pdf-sidebar');
        sidebar.innerHTML = '';
        const dpr = window.devicePixelRatio || 1;
        
        for (let i = 1; i <= this.doc.numPages; i++) {
            const page = await this.doc.getPage(i);
            const wrapper = document.createElement('div');
            wrapper.className = 'pdf-thumb-wrapper';
            if(i === 1) wrapper.classList.add('active');
            wrapper.onclick = () => {
                this.renderPage(i, false);
                document.querySelectorAll('.pdf-thumb-wrapper').forEach(w => w.classList.remove('active'));
                wrapper.classList.add('active');
            };
            
            const viewport = page.getViewport({ scale: 0.2 }); 
            const outputScale = 0.2 * dpr;
            const canvas = document.createElement('canvas');
            canvas.className = 'pdf-thumb-canvas';
            canvas.width = viewport.width * dpr; 
            canvas.height = viewport.height * dpr;
            canvas.style.width = Math.floor(viewport.width) + "px";
            canvas.style.height = Math.floor(viewport.height) + "px";
            
            const ctx = canvas.getContext('2d');
            page.render({ canvasContext: ctx, viewport: page.getViewport({ scale: outputScale }) });
            
            const num = document.createElement('div');
            num.className = 'pdf-page-num';
            num.innerText = i;
            wrapper.appendChild(canvas);
            wrapper.appendChild(num);
            sidebar.appendChild(wrapper);
        }
    }

    static async renderPage(num, autoFit) {
        this.currentPage = num;
        const container = document.getElementById('pdf-main-view');
        container.innerHTML = ''; 
        const page = await this.doc.getPage(num);
        
        if (autoFit) {
            const desiredWidth = container.clientWidth - 40; 
            const viewportUnscaled = page.getViewport({ scale: 1 });
            this.currentScale = desiredWidth / viewportUnscaled.width;
        }
        
        document.getElementById('pdf-zoom-level').innerText = Math.round(this.currentScale * 100) + "%";

        const dpr = window.devicePixelRatio || 1;
        const outputScale = this.currentScale * dpr;
        const viewport = page.getViewport({ scale: this.currentScale });

        const canvas = document.createElement('canvas');
        canvas.width = viewport.width * dpr;
        canvas.height = viewport.height * dpr;
        canvas.style.width = Math.floor(viewport.width) + "px";
        canvas.style.height = Math.floor(viewport.height) + "px";
        
        await page.render({ canvasContext: canvas.getContext('2d'), viewport: page.getViewport({ scale: outputScale }) }).promise;
        container.appendChild(canvas);
    }

    static async renderMobileStack() {
        const container = document.getElementById('pdf-main-view');
        container.innerHTML = ''; 
        document.getElementById('pdf-zoom-level').innerText = Math.round(this.currentScale * 100) + "%";
        
        const dpr = window.devicePixelRatio || 1;
        const outputScale = this.currentScale * dpr;

        for (let i = 1; i <= this.doc.numPages; i++) {
            await new Promise(r => setTimeout(r, 10));
            
            const page = await this.doc.getPage(i);
            const viewport = page.getViewport({ scale: this.currentScale });
            
            const wrapper = document.createElement('div');
            wrapper.className = 'pdf-page-container';
            
            const canvas = document.createElement('canvas');
            canvas.className = 'pdf-page-canvas';
            canvas.width = viewport.width * dpr;
            canvas.height = viewport.height * dpr;
            canvas.style.width = Math.floor(viewport.width) + "px";
            canvas.style.height = Math.floor(viewport.height) + "px";
            
            wrapper.appendChild(canvas);
            container.appendChild(wrapper);
            
            page.render({ canvasContext: canvas.getContext('2d'), viewport: page.getViewport({ scale: outputScale }) });
        }
    }
    
    static zoom(delta) {
        this.currentScale += delta;
        if(this.currentScale < 0.2) this.currentScale = 0.2;
        
        if(this.isMobile) {
            this.renderMobileStack();
        } else {
            this.renderPage(this.currentPage, false);
        }
    }
    
    static print() {
        if(this.url) window.open(this.url, '_blank');
    }
}

class PdfController {
    static load(id, url) {
        const placeholder = document.getElementById('pdf-placeholder-text');
        if(placeholder) placeholder.style.display = 'none';
        const link = document.getElementById('pdf-fallback-link');
        if(link) link.href = url || "#";
        if (!url) {
            document.getElementById('pdf-fallback').style.display = 'block';
            return;
        }
        PdfViewer.load(url);
        if(window.innerWidth < 768) document.body.classList.add('viewing-pdf');
    }
}

// --- DB & LOGIC ---
class DB {
    static open() { 
        return new Promise((r, j) => { 
            const q = indexedDB.open("CoxSchematicDB", 8); 
            q.onupgradeneeded = e => { 
                const d = e.target.result; 
                if(d.objectStoreNames.contains("cache")) d.deleteObjectStore("cache"); 
                if(d.objectStoreNames.contains("chunks")) d.deleteObjectStore("chunks"); 
                d.createObjectStore("chunks"); 
            }; 
            q.onsuccess = e => r(e.target.result); 
            q.onerror = e => j(e); 
        }); 
    }
    static async putChunk(k, v) { const d = await this.open(); return new Promise((r, j) => { const t = d.transaction("chunks", "readwrite"); t.objectStore("chunks").put(v, k); t.oncomplete = r; t.onerror = j; }); }
    static async getChunk(k) { const d = await this.open(); return new Promise((r, j) => { const t = d.transaction("chunks", "readonly"); const q = t.objectStore("chunks").get(k); q.onsuccess = () => r(q.result); q.onerror = j; }); }
    static async getChunkKeys() { const d = await this.open(); return new Promise((r, j) => { const t = d.transaction("chunks", "readonly"); const q = t.objectStore("chunks").getAllKeys(); q.onsuccess = () => r(q.result); q.onerror = j; }); }
    static async deleteLegacy() { try { const d = await this.open(); const t = d.transaction("cache", "readwrite"); t.objectStore("cache").clear(); } catch(e){} }
}

class CacheService {
    static activeKey = null;

    static async prepareKey(p) {
        if(!p) return null;
        const e = new TextEncoder(); 
        const k = await crypto.subtle.importKey("raw", e.encode(p), "PBKDF2", false, ["deriveKey"]); 
        this.activeKey = await crypto.subtle.deriveKey({ name: "PBKDF2", salt: e.encode("COX_SALT_V1"), iterations: 100000, hash: "SHA-256" }, k, { name: "AES-GCM", length: 256 }, true, ["encrypt", "decrypt"]);
        return this.activeKey;
    }

    static async saveShard(id, data) { 
        if(!this.activeKey) return; 
        const j = JSON.stringify(data); 
        const e = await this.enc(j); 
        await DB.putChunk(id, e); 
    }

    static async loadAllWithProgress(progressCallback) { 
        if(!this.activeKey) return null;
        const keys = await DB.getChunkKeys();
        if(!keys || keys.length === 0) return null;
        for(let i = 0; i < keys.length; i++) {
            if(i % 5 === 0) await new Promise(r => setTimeout(r, 5));
            const chunk = await DB.getChunk(keys[i]);
            if(chunk) {
                try {
                    const dec = await this.dec(chunk);
                    if(dec) {
                        const data = JSON.parse(dec);
                        data.forEach(r => {
                            window.LOCAL_DB.push(r);
                            window.ID_MAP.set(r.id, r);
                            if(r.mfg) window.FOUND_MFGS.add(r.mfg);
                        });
                    }
                } catch(e) {}
            }
            if(progressCallback) progressCallback(Math.round(((i + 1) / keys.length) * 100));
        }
        return true;
    }

    static async enc(t) { 
        const iv = crypto.getRandomValues(new Uint8Array(12)); 
        const e = await crypto.subtle.encrypt({ name: "AES-GCM", iv }, this.activeKey, new TextEncoder().encode(t)); 
        return Array.from(iv).map(b=>b.toString(16).padStart(2,'0')).join('') + ":" + Array.from(new Uint8Array(e)).map(b=>b.toString(16).padStart(2,'0')).join(''); 
    }

    static async dec(t) { 
        const [i, d] = t.split(':'); 
        const iv = new Uint8Array(i.match(/.{1,2}/g).map(b=>parseInt(b,16))); 
        const da = new Uint8Array(d.match(/.{1,2}/g).map(b=>parseInt(b,16))); 
        try { return new TextDecoder().decode(await crypto.subtle.decrypt({ name: "AES-GCM", iv }, this.activeKey, da)); } catch { return null; } 
    }
}

class AuthService {
    static init() { const u = localStorage.getItem('cox_user'); const p = localStorage.getItem('cox_pass'); if (u && p) { document.documentElement.classList.add('logged-in'); document.getElementById('auth-overlay').classList.remove('active-modal'); UI.pop(); return true; } return false; }
    static login() { const u = document.getElementById('auth-user').value.trim(); const p = document.getElementById('auth-pass').value.trim(); if (!u || !p) return alert("Missing Credentials"); localStorage.setItem('cox_user', u); localStorage.setItem('cox_pass', p); location.reload(); }
    static async logout() { localStorage.clear(); sessionStorage.clear(); await DB.clear(); location.reload(); }
    static headers() { return { 'X-Cox-User': localStorage.getItem('cox_user'), 'X-Cox-Pass': localStorage.getItem('cox_pass') }; }
}

class NetworkService {
    static async fetch(t, p='') { const b = WORKER_URL.startsWith('http') ? WORKER_URL : `https://${WORKER_URL}`; return fetch(`${b}?target=${encodeURIComponent(t)}${p.replace('?', '&')}`, { headers: AuthService.headers() }); }
    static async post(t, d) { const b = WORKER_URL.startsWith('http') ? WORKER_URL : `https://${WORKER_URL}`; return fetch(`${b}?target=${encodeURIComponent(t)}`, { method: 'POST', headers: { 'Content-Type': 'application/json', ...AuthService.headers() }, body: JSON.stringify(d) }); }
}

class FeedbackService { 
    static activeId = null; static sessionVotes = new Set();
    static down(id) { this.activeId = id; document.getElementById('feedback-modal').classList.add('active-modal'); } 
    static async submit() { 
        const id = this.activeId; const submissions = []; 
        document.querySelectorAll('.reason-btn.selected').forEach(btn => { 
            const reasonCode = btn.dataset.reason; 
            const val = btn.nextElementSibling ? btn.nextElementSibling.value : "";
            submissions.push({ id, reasonCode, value: val }); 
        }); 
        for(const sub of submissions) await NetworkService.post(CONFIG.feedbackTable, { "fields": { "Panel ID": sub.id, "Parameter": sub.reasonCode, "Suggested Value": sub.value } }); 
        document.getElementById('feedback-modal').classList.remove('active-modal');
    } 
    static async up(id, btnElement) { 
        if(this.sessionVotes.has(id)) return; this.sessionVotes.add(id); if(btnElement) btnElement.classList.add('voted-up');
        const mfg = document.getElementById('mfgInput').value; const hp = document.getElementById('hpInput').value;
        const volt = document.getElementById('voltInput').value; const phase = document.getElementById('phaseInput').value; const enc = document.getElementById('encInput').value;
        const submissions = [{ "fields": { "Panel ID": id, "Parameter": "VERIFIED", "Suggested Value": "General Match" } }];
        if(mfg!=="Any") submissions.push({ "fields": { "Panel ID": id, "Parameter": "mfg", "Suggested Value": mfg } });
        if(hp!=="Any") submissions.push({ "fields": { "Panel ID": id, "Parameter": "hp", "Suggested Value": hp } });
        if(volt!=="Any") submissions.push({ "fields": { "Panel ID": id, "Parameter": "volt", "Suggested Value": volt } });
        if(phase!=="Any") submissions.push({ "fields": { "Panel ID": id, "Parameter": "phase", "Suggested Value": phase } });
        if(enc!=="Any") submissions.push({ "fields": { "Panel ID": id, "Parameter": "enc", "Suggested Value": enc } });
        for(const sub of submissions) await NetworkService.post(CONFIG.feedbackTable, sub);
    } 
    static toggleReason(el) { el.classList.toggle('selected'); } 
    static close() { document.getElementById('feedback-modal').classList.remove('active-modal'); } 
}

const AI_TRAINING_DATA = { 
    MANUFACTURERS: { 'gorman rupp':['gorman','gr'], 'barnes':['barnes','sithe'], 'hydromatic':['hydromatic'], 'flygt':['flygt'], 'myers':['myers'], 'goulds':['goulds'], 'zoeller':['zoeller'], 'liberty':['liberty'], 'wilo':['wilo'], 'pentair':['pentair'], 'abs':['abs'], 'aurora':['aurora'], 'baldor':['baldor'] }, 
    ENCLOSURES: { '4XSS': ['4XSS', 'STAINLESS', 'SS'], '4XFG': ['4XFG', 'FIBERGLASS', 'FG'], 'POLY': ['POLY'], 'NEMA 12': ['NEMA 12'], 'NEMA 4': ['NEMA 4'], 'NEMA 1': ['NEMA 1'] },
    DATA: { HP: [0.5, 0.75, 1, 1.5, 2, 3, 5, 7.5, 10, 15, 20, 25, 30, 40, 50, 60, 75, 100], VOLT: [120, 208, 240, 480, 575], PHASE: [1, 3] } 
};

class TheHealer {
    static healedData = {}; 
    static async fetchAndTally() {
        try {
            const resp = await NetworkService.fetch(CONFIG.feedbackTable, '?pageSize=100');
            if(resp.status === 401) { AuthService.logout(); return; }
            const data = await resp.json();
            if(data.records) {
                const tallies = {};
                data.records.forEach(r => {
                    const key = `${r.fields['Panel ID']}|${r.fields['Parameter']}|${r.fields['Suggested Value']}`;
                    tallies[key] = (tallies[key] || 0) + 1;
                });
                for (const [key, count] of Object.entries(tallies)) {
                    if (count >= CONFIG.voteThreshold) {
                        const [id, param, value] = key.split('|');
                        if (!this.healedData[id]) this.healedData[id] = {};
                        this.healedData[id][param] = value;
                    }
                }
            }
        } catch(e) { console.error("Healing Failed", e); }
    }
}

class AIParser {
    static parse(t, id) {
        const healed = TheHealer.healedData[id];
        const s = { mfg: healed?.mfg||null, hp: healed?.hp||null, enc: healed?.enc||null, volt: healed?.volt||null, phase: healed?.phase||null };
        t = (t||"").toUpperCase();
        for (const [k, v] of Object.entries(AI_TRAINING_DATA.MANUFACTURERS)) if (new RegExp(`\\b(${v.join('|').toUpperCase()})\\b`).test(t)) s.mfg = k.toUpperCase();
        if (!s.enc) for (const [k, v] of Object.entries(AI_TRAINING_DATA.ENCLOSURES)) if (v.some(val => t.includes(val))) { s.enc = k; break; }
        
        if (!s.hp) { 
            let m = t.match(/(?:^|[^/])\b(\d+(?:\.\d+)?)\s*[\-_]?\s*HP\b/i); 
            if (!m) m = t.match(/\bHP\s*[:\s\-_.]*\s*(\d+(?:\.\d+)?)(?!\/)/i); 
            if(m) s.hp = parseFloat(m[1]).toString(); 
        }

        if (!s.volt) { const m = t.match(/\b(115|120|208|230|240|277|460|480|575)\s*V(?:olt)?(?:age)?\b/i); if(m) s.volt = m[1]; }
        if (!s.phase) { if (t.includes("3 PHASE") || t.includes("3PH") || t.includes("3√ò") || t.includes("3/60")) s.phase = "3"; else if (t.includes("1 PHASE") || t.includes("1PH") || t.includes("1√ò") || t.includes("1/60")) s.phase = "1"; if(!s.phase && (t.includes("240/1/60") || t.includes("120/240"))) s.phase = "1"; if(!s.phase && (t.includes("480/3/60") || t.includes("277/480"))) s.phase = "3"; }
        return s;
    }
}

window.LOCAL_DB = []; window.ID_MAP = new Map(); window.FOUND_MFGS = new Set();
class DataLoader {
    static async preload() {
        const btn = document.getElementById('searchBtn'); 
        btn.disabled = true; 
        btn.innerText = "üîí PREPARING...";
        
        await new Promise(r => setTimeout(r, 200)); 

        const p = localStorage.getItem('cox_pass'); 
        
        await CacheService.prepareKey(p);
        
        await DB.deleteLegacy();

        let attempts = parseInt(localStorage.getItem('cox_sync_attempts') || '0');
        if(attempts > 2) {
            btn.innerText = "‚ö†Ô∏è SYNC INTERRUPTED (RETRY?)";
            btn.classList.add('warning');
            btn.disabled = false;
            btn.onclick = () => { localStorage.setItem('cox_sync_attempts', '0'); location.reload(); };
            return;
        }
        localStorage.setItem('cox_sync_attempts', (attempts + 1).toString());

        // --- BATCHED DECRYPT START ---
        const hasData = await CacheService.loadAllWithProgress((pct) => {
            btn.innerText = `üîí DECRYPTING ${pct}%`;
        });

        if(hasData) {
            UI.pop();
            if(localStorage.getItem('cox_db_complete')) {
                localStorage.setItem('cox_sync_attempts', '0');
                btn.innerText = "SEARCH"; btn.disabled = false;
                return; // DONE
            } else {
                btn.innerText = "‚¨áÔ∏è RESUMING..."; 
            }
        } else {
            btn.innerText = "‚¨áÔ∏è SYNCING...";
        }
        
        await new Promise(r => setTimeout(r, 50));
        
        await TheHealer.fetchAndTally();
        await this.fetchPartition('desc', btn);
        
        localStorage.setItem('cox_sync_attempts', '0');
        
        if(btn.innerText.includes("SYNCING") || btn.innerText.includes("RESUMING") || btn.innerText.includes("FINALIZING") || btn.disabled) { 
            btn.innerText = "SEARCH"; btn.disabled = false; 
        }
        UI.pop();
    }
    static async fetchPartition(dir, btn) {
        let offset = null, loop = 0;
        let buffer = []; 
        let shardCount = 0;

        try {
            do {
                loop++; if(loop > 300 || window.LOCAL_DB.length >= 7500) break;
                await new Promise(r => setTimeout(r, 10));

                if(btn && !btn.classList.contains('warning')) {
                    const pct = Math.min(99, Math.round((window.LOCAL_DB.length/CONFIG.estTotal)*100));
                    if(pct < 100) btn.innerText = `‚¨áÔ∏è SYNCING ${pct}%`;
                }

                const r = await NetworkService.fetch(CONFIG.mainTable, `?pageSize=100&fields[]=Control Panel Name&fields[]=Items&fields[]=Control Panel PDF${offset ? '&offset='+offset : ''}&sort%5B0%5D%5Bfield%5D=Control%20Panel%20Name&sort%5B0%5D%5Bdirection%5D=${dir}`);
                if(r.status!==200) { console.error("Sync Failed", r.status); break; }
                const d = await r.json(); 
                
                if(!d.records || d.records.length === 0) {
                    localStorage.setItem('cox_db_complete', 'true');
                    break;
                }
                
                d.records.forEach(r => {
                    const id = (r.fields['Control Panel Name']||"").replace(/\.dwg$/i, '').replace(/\.pdf$/i, '').replace(/[!?]/g,'').trim();
                    const url = r.fields['Control Panel PDF']?.[0]?.url;
                    if(window.ID_MAP.has(id)) { window.ID_MAP.get(id).pdfUrl = url; }
                    else {
                        const rec = { id, desc: (r.fields['Items']||"").toUpperCase(), pdfUrl: url, ...AIParser.parse((id+" "+(r.fields['Items']||"")).toUpperCase(), id) };
                        window.LOCAL_DB.push(rec); 
                        window.ID_MAP.set(id, rec); 
                        if(rec.mfg) window.FOUND_MFGS.add(rec.mfg);
                        buffer.push(rec);
                    }
                });

                if(buffer.length >= 25) {
                    await CacheService.saveShard(`shard_${Date.now()}_${shardCount++}`, buffer);
                    buffer = []; 
                }

                offset = d.offset;
            } while(offset);

            if(buffer.length > 0) {
                if(btn) btn.innerText = "‚úÖ FINALIZING...";
                
                await new Promise(resolve => {
                    requestAnimationFrame(() => {
                        setTimeout(resolve, 50); 
                    });
                });
                
                await CacheService.saveShard(`shard_${Date.now()}_final`, buffer);
            }
        } catch(e) {
            console.error("Sync Critical Error", e);
        } finally {
            if(btn && !btn.classList.contains('warning')) { btn.innerText = "SEARCH"; btn.disabled = false; }
        }
    }
}

class SearchEngine {
    static perform() {
        const kw = document.getElementById('keywordInput').value.split(',').map(s=>s.trim()).filter(s=>s.length);
        const crit = { kw, mfg: document.getElementById('mfgInput').value, hp: document.getElementById('hpInput').value, volt: document.getElementById('voltInput').value, phase: document.getElementById('phaseInput').value, enc: document.getElementById('encInput').value };
        let res = [];
        window.LOCAL_DB.forEach(r => {
            let w = 0, p = true, hpV = false, miss = 0;
            if(crit.kw.length) { if(!crit.kw.every(k => (r.id+" "+r.desc).toUpperCase().includes(k.toUpperCase()))) return; w+=10; }
            if(crit.mfg!=="Any") { if(r.mfg===crit.mfg.toUpperCase()) w+=50000; else { if(!r.mfg) { w-=10000; p=false; miss++; } else return; } }
            if(crit.hp!=="Any") { if(r.hp) { if(parseFloat(r.hp)===parseFloat(crit.hp)) w+=100; else { w+=10; p=false; miss++; } } else { w+=5; p=false; miss++; } }
            if(crit.volt!=="Any") { if(!r.volt || !r.volt.includes(crit.volt)) { p=false; miss++; w-=10000; } }
            if(crit.phase!=="Any") { if(r.phase && r.phase!==crit.phase) return; if(!r.phase) { p=false; miss++; w-=5000; } }
            if(crit.enc!=="Any") { if(r.enc!==crit.enc) { p=false; miss++; w-=1000; } }
            if(!p && miss===1 && crit.hp!=="Any" && r.hp && parseFloat(r.hp)!==parseFloat(crit.hp)) hpV=true;
            r.w=w; r.p=p; r.hpV=hpV; res.push(r);
        });
        res.sort((a,b) => { if(a.p!=b.p) return a.p?-1:1; if(a.hpV!=b.hpV) return a.hpV?-1:1; if(a.w!=b.w) return b.w-a.w; return b.id.localeCompare(a.id, undefined, {numeric:true, sensitivity:'base'}); });
        UI.render(res, crit); UI.toggleSearch(false);
    }
}

class UI {
    static init() {
        // Theme Persistence
        if(localStorage.getItem('cox_theme') === 'dark') {
            document.body.classList.add('dark-mode');
        }
    }

    static toggleDarkMode() {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('cox_theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
    }

    static handleEnter(e) { if(e.key==='Enter') SearchEngine.perform(); }
    static resetSearch() { document.querySelectorAll('select').forEach(s=>s.value="Any"); document.getElementById('keywordInput').value=''; this.toggleSearch(true); }
    static closeMobilePreview() { document.body.classList.remove('viewing-pdf'); }
    static toggleSearch(e) { const c = document.getElementById('search-controls'); if(e) { c.classList.remove('collapsed'); document.getElementById('refine-btn-area').classList.remove('visible'); } else { c.classList.add('collapsed'); document.getElementById('refine-btn-area').classList.add('visible'); } }
    static pop() {
        const m = document.getElementById('mfgInput'); const cv = m.value;
        let all = Array.from(window.FOUND_MFGS).sort(); m.innerHTML='<option value="Any">Any</option>'; all.forEach(v=>m.add(new Option(v,v))); m.value=cv;
        ['hp','volt','phase','enc'].forEach(k=>{ const s=document.getElementById(k+'Input'); if(!s)return; const d=(k==='enc')?Object.keys(AI_TRAINING_DATA.ENCLOSURES):AI_TRAINING_DATA.DATA[k.toUpperCase()]; s.innerHTML='<option value="Any">Any</option>'; d.forEach(v=>s.add(new Option(v,v))); });
    }
    static render(res, crit) {
        const a = document.getElementById('results-area'); a.innerHTML = `<div style="padding:5px;font-size:12px;opacity:0.7;">Found ${res.length} records</div>`;
        res.slice(0,50).forEach(i => {
            const h = TheHealer.healedData[i.id]; let b = '';
            if(crit.volt!=="Any" && i.volt) b+=`<span class="hud-badge ${i.volt.includes(crit.volt)?'match-green':'match-red'}">${h?.volt||i.volt}V</span>`;
            if(crit.phase!=="Any" && i.phase) b+=`<span class="hud-badge ${i.phase===crit.phase?'match-green':'match-red'}">${h?.phase||i.phase}PH</span>`;
            if(crit.hp!=="Any" && i.hp) b+=`<span class="hud-badge ${parseFloat(i.hp)===parseFloat(crit.hp)?'match-green':'match-orange'}">${h?.hp||i.hp} HP</span>`;
            if(crit.mfg!=="Any") b+=`<span class="hud-badge ${i.mfg===crit.mfg.toUpperCase()?'match-green':'match-orange'}">${h?.mfg||i.mfg||'Unknown'}</span>`;
            if(crit.enc!=="Any" && i.enc) b+=`<span class="hud-badge ${i.enc===crit.enc?'match-green':'match-orange'}">${h?.enc||i.enc}</span>`;
            crit.kw.forEach(k=>b+=`<span class="hud-badge match-keyword">${k.toUpperCase()}</span>`);
            const c = document.createElement('div'); c.className = `record-card ${!i.p?'varied-result':''}`;
            c.innerHTML = `<div class="panel-name">${i.id}</div><div class="badge-row">${b}</div><div class="card-actions"><button class="thumb-btn up" onclick="event.stopPropagation();FeedbackService.up('${i.id}',this)">üëç</button><button class="thumb-btn down" onclick="event.stopPropagation();FeedbackService.down('${i.id}')">üëé</button></div>`;
            c.onclick = () => { document.querySelectorAll('.record-card').forEach(x=>x.classList.remove('active-view')); c.classList.add('active-view'); PdfController.load(i.id, i.pdfUrl); };
            a.appendChild(c);
        });
    }
}

document.addEventListener('DOMContentLoaded', () => { 
    UI.init(); // Initialize UI Preference
    if(AuthService.init()) { DataLoader.preload(); } 
});
</script>
</body>
</html>