<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cox Research | SCHEMATICai (v9.3 - The AI Pipeline)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <script type="module" src="database.js"></script>

    <script>
        try {
            const session = JSON.parse(localStorage.getItem('cox_auth_session'));
            if (session && session.expiry > Date.now()) {
                document.documentElement.classList.add('logged-in');
            }
        } catch(e) {}
    </script>
    
    <style>
        :root { 
            --app-primary: #461D7C;        
            --bg-app: #e3e5e8; 
            --bg-sidebar: #ffffff; 
            --bg-card: #ffffff;
            --bg-controls: rgba(255,255,255,0.98); 
            --bg-viewer: #323639; 
            --bg-input: #ffffff;
            --text-primary: #121212; 
            --text-secondary: #5f6368; 
            --border-color: #c7c7cc; 
            
            --match-exact-bg: #dcfce7; --match-exact-text: #166534; 
            --badge-info-bg: #f3f4f6; --badge-info-text: #6b7280;
            --badge-healed-bg: #dbeafe; --badge-healed-text: #1e40af;
            
            --header-height: 80px; 
            --input-height: 48px;
            color-scheme: light; 
        }

        body.dark-mode {
            --bg-app: #121212; --bg-sidebar: #1e1e1e; --bg-card: #2d2d2d; 
            --bg-controls: rgba(30, 30, 30, 0.98); --bg-viewer: #1a1a1a; 
            --bg-input: #383838; 
            --text-primary: #e8eaed; --text-secondary: #9aa0a6; 
            --border-color: #3c4043;
            
            --match-exact-bg: #14532d; --match-exact-text: #86efac; 
            --badge-info-bg: #374151; --badge-info-text: #9ca3af;
            --badge-healed-bg: #1e3a8a; --badge-healed-text: #93c5fd;
            color-scheme: dark;            
        }
        
        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; background-color: var(--bg-app); color: var(--text-primary); height: 100vh; display: flex; flex-direction: column; overflow: hidden; font-size: 15px; }

        header { background: linear-gradient(135deg, #461D7C 0%, #2e0e57 100%); height: var(--header-height); padding: 0 25px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 100; flex-shrink: 0; position: relative; }
        .logo-group { text-decoration: none; display: flex; flex-direction: column; line-height: 1; z-index: 2; }
        .logo-main { font-family: 'Helvetica Neue', Arial, sans-serif; font-size: 2.2rem; font-weight: 900; color: white; letter-spacing: -1px; text-transform: uppercase; }
        .logo-sub { font-family: 'Helvetica Neue', Arial, sans-serif; font-size: 0.75rem; color: #b39ddb; font-weight: 700; letter-spacing: 4px; text-transform: uppercase; margin-top: 4px; }
        
        .version-badge { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.3); color: white; padding: 6px 16px; border-radius: 20px; font-weight: 800; font-size: 13px; letter-spacing: 1px; white-space: nowrap; pointer-events: none; }

        .header-controls { display: flex; align-items: center; gap: 12px; margin-left: auto; z-index: 2; }
        .control-btn { background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.3); color: white; width: 42px; height: 42px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; transition: all 0.2s; overflow: hidden; }
        .btn-bug { font-size: 14px; }
        
        #settings-btn-wrapper { display: none; }

        #app-container { display: none; flex: 1; overflow: hidden; height: calc(100vh - var(--header-height)); }
        html.logged-in #app-container { display: flex !important; }
        
        #sidebar { width: 420px; min-width: 320px; background: var(--bg-sidebar); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; z-index: 20; }
        .sidebar-controls { padding: 15px; background: var(--bg-controls); border-bottom: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 10px; }
        
        .filter-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .input-group { display: flex; flex-direction: column; gap: 2px; }
        .input-label { font-size: 10px; font-weight: 800; text-transform: uppercase; color: var(--text-secondary); }
        .cox-input { width: 100%; height: var(--input-height); padding: 0 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; background: var(--bg-input); color: var(--text-primary); outline: none; }
        .search-btn { flex: 1; height: 40px; background-color: #461D7C !important; color: white !important; border: none; border-radius: 6px; font-weight: 800; cursor: pointer; transition: 0.3s; }
        .search-btn:disabled { background-color: #9ca3af !important; cursor: not-allowed; opacity: 0.8; }
        .reset-btn { height: 40px; width: 40px; background: var(--bg-app); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; }

        #results-scroll-area { flex: 1; overflow-y: auto; padding: 15px; background: var(--bg-app); }
        #results-area { display: flex; flex-direction: column; gap: 8px; padding-bottom: 80px; }

        .record-card { background: var(--bg-card); padding: 12px 15px; border-radius: 8px; border: 1px solid var(--border-color); border-left: 6px solid var(--app-primary); box-shadow: 0 1px 3px rgba(0,0,0,0.05); cursor: pointer; position: relative; transition: all 0.2s; display: flex; flex-direction: column; gap: 10px; }
        .record-card:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .record-card.active-view { background: rgba(70, 29, 124, 0.03); border-color: var(--app-primary); }
        
        .card-header { display: flex; justify-content: space-between; align-items: center; }
        .panel-name { font-size: 24px; font-weight: 900; color: var(--app-primary); margin: 0; letter-spacing: -0.5px; }

        .badge-row { display: flex; gap: 6px; flex-wrap: wrap; }
        .hud-badge { font-size: 11px; font-weight: 800; text-transform: uppercase; padding: 4px 10px; border-radius: 6px; letter-spacing: 0.5px; border: 1px solid transparent; }
        .hud-badge.match-exact { background: var(--match-exact-bg); color: var(--match-exact-text); border-color: var(--match-exact-border); }
        .hud-badge.match-info { background: var(--badge-info-bg); color: var(--badge-info-text); border-color: transparent; }
        .hud-badge.match-healed { background: var(--badge-healed-bg); color: var(--badge-healed-text); border-color: transparent; }

        .card-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 4px; border-top: 1px solid var(--border-color); padding-top: 8px; }
        .thumb-btn { background: transparent; border: 1px solid var(--border-color); border-radius: 4px; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; transition: 0.2s; }
        .thumb-btn:hover { background: #f5f5f5; }
        .thumb-btn.voted-up { background: #dcfce7; border-color: #166534; color: #166534; pointer-events: none; }
        .thumb-btn.voted-down { background: #fee2e2; border-color: #991b1b; color: #991b1b; }

        #auth-overlay, #feedback-modal, #config-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(4px); z-index: 10000; align-items: center; justify-content: center; }
        .active-modal { display: flex !important; }
        
        .auth-card, .config-card { background: var(--bg-card); padding: 40px; border-radius: 12px; width: 100%; max-width: 400px; text-align: center; border: 1px solid var(--border-color); }
        .modal-card { width: 400px; background: var(--bg-card); border-radius: 12px; overflow: hidden; border: 1px solid var(--border-color); }
        .modal-header { background: var(--app-primary); padding: 15px; display: flex; justify-content: space-between; align-items: center; color: white; font-weight: 700; }
        .modal-content { padding: 20px; }
        
        .reason-row { display: flex; flex-direction: column; gap: 5px; margin-bottom: 8px; }
        .reason-btn { padding: 10px; border: 1px solid var(--border-color); background: var(--bg-input); color: var(--text-primary); border-radius: 6px; cursor: pointer; text-align: center; font-size: 12px; font-weight: 600; width: 100%; }
        .reason-btn.selected { background: var(--status-error); color: white; border-color: var(--status-error); }
        
        .correction-input { display: none; width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; margin-top: 4px; }
        .reason-btn.selected + .correction-input { display: block; }
        
        .submit-feedback-btn { width: 100%; padding: 12px; background: var(--app-primary); color: white; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; margin-top: 15px; }

        #preview-pane { flex: 1; background: var(--bg-viewer); display: flex; flex-direction: column; align-items: center; justify-content: center; color: rgba(255,255,255,0.5); font-size: 20px; position:relative; overflow: hidden; }
        #pdf-viewer-frame { width: 100%; height: 100%; border: none; background: #fff; }
        .pdf-fallback { display: none; text-align: center; color: white; padding: 20px; }
        .pdf-fallback a { display: inline-block; margin-top: 10px; color: #b39ddb; text-decoration: underline; font-size: 14px; cursor: pointer; }
        
        @media (max-width: 900px) { #sidebar { width: 100%; } #preview-pane { display: none; } }
    </style>
</head>
<body>

<div id="auth-overlay">
    <div class="auth-card">
        <h2 style="color:var(--app-primary); margin-top:0;">SCHEMATICai</h2>
        <input type="text" id="auth-user" class="cox-input" placeholder="Username" style="margin-bottom:10px;">
        <button class="submit-feedback-btn" onclick="AuthService.login()">Authenticate</button>
    </div>
</div>

<div id="config-modal">
    <div class="config-card">
        <h3 style="margin-top:0; color:var(--app-primary);">üõ†Ô∏è Admin Tools</h3>
        <p style="font-size:12px; color:var(--text-secondary); margin-bottom:20px;">
            Status: <span id="db-status-text">Idle</span>
        </p>
        <button class="submit-feedback-btn" style="background:var(--status-success);" onclick="DataLoader.harvestCSV()">üì• Harvest Golden CSV</button>
        <button class="submit-feedback-btn" style="background:var(--status-error); margin-top:8px;" onclick="ConfigService.reset()">üóëÔ∏è Clear Cache</button>
        <div style="margin-top:10px;"><button class="submit-feedback-btn" style="background:#555;" onclick="document.getElementById('config-modal').classList.remove('active-modal')">Close</button></div>
    </div>
</div>

<header>
    <a href="#" class="logo-group">
        <span class="logo-main">COX</span>
        <span class="logo-sub">RESEARCH</span>
    </a>
    <div class="version-badge">SCHEMATICai v9.3</div>
    <div class="header-controls">
        <div id="settings-btn-wrapper">
            <button class="control-btn" title="Admin Settings" onclick="document.getElementById('config-modal').classList.add('active-modal')">‚öôÔ∏è</button>
        </div>
        <button class="control-btn btn-bug" onclick="FeedbackService.down(null)">üêû</button>
        <button class="control-btn" onclick="UI.toggleDarkMode()">üåì</button>
        <button class="control-btn" onclick="AuthService.logout()">‚èª</button>
    </div>
</header>

<div id="feedback-modal">
    <div class="modal-card">
        <div class="modal-header">
            <span>Report Inaccuracy</span>
            <button class="control-btn" style="width:24px;height:24px;font-size:12px;background:rgba(255,255,255,0.2);" onclick="FeedbackService.close()">X</button>
        </div>
        <div class="modal-content">
            <p style="font-size:12px; color:#666; margin-top:0;">Select parameter and enter correct value:</p>
            
            <div class="reason-row">
                <div class="reason-btn" data-reason="mfg" onclick="FeedbackService.toggleReason(this)">Wrong Manufacturer</div>
                <input type="text" class="correction-input" placeholder="Correct Manufacturer (e.g. BARNES)">
            </div>
            
            <div class="reason-row">
                <div class="reason-btn" data-reason="hp" onclick="FeedbackService.toggleReason(this)">Wrong HP</div>
                <input type="text" class="correction-input" placeholder="Correct HP (e.g. 10)">
            </div>
            
            <div class="reason-row">
                <div class="reason-btn" data-reason="volt" onclick="FeedbackService.toggleReason(this)">Wrong Voltage</div>
                <input type="text" class="correction-input" placeholder="Correct Voltage (e.g. 480)">
            </div>
            
            <div class="reason-row">
                <div class="reason-btn" data-reason="phase" onclick="FeedbackService.toggleReason(this)">Wrong Phase</div>
                <input type="text" class="correction-input" placeholder="Correct Phase (e.g. 3)">
            </div>

            <button class="submit-feedback-btn" onclick="FeedbackService.submit()">SUBMIT & VOTE</button>
        </div>
    </div>
</div>

<div id="app-container">
    <div id="sidebar">
        <div class="sidebar-controls">
            <div class="input-group"><span class="input-label">Keywords</span><input type="text" id="keywordInput" class="cox-input" placeholder="e.g. Duplex, 1PH, CP-7920" onkeypress="UI.handleEnter(event)"></div>
            <div class="filter-grid">
                <div class="input-group"><span class="input-label">Manufacturer</span><select id="mfgInput" class="cox-input"><option value="Any">Any</option></select></div>
                <div class="input-group"><span class="input-label">Phase</span><select id="phaseInput" class="cox-input"><option value="Any">Any</option></select></div>
                <div class="input-group"><span class="input-label">HP</span><select id="hpInput" class="cox-input"><option value="Any">Any</option></select></div>
                <div class="input-group"><span class="input-label">Voltage</span><select id="voltInput" class="cox-input"><option value="Any">Any</option></select></div>
            </div>
            <div style="display:flex; gap:8px; margin-top:5px;">
                <button class="reset-btn" onclick="UI.resetSearch()">‚Ü∫</button>
                <button class="search-btn" id="searchBtn" onclick="SearchEngine.perform()" disabled>LOADING DB...</button>
            </div>
        </div>
        <div id="results-scroll-area"><div id="results-area"></div></div>
    </div>
    <div id="preview-pane">
        <div id="pdf-placeholder-text">üìÑ Select a schematic to view</div>
        <iframe id="pdf-viewer-frame" style="display:none;"></iframe>
        <div id="pdf-fallback" class="pdf-fallback">
            <div style="margin-bottom:10px;">‚ö†Ô∏è PDF Link Not Found</div>
            <div style="font-size:12px; opacity:0.7;" id="pdf-debug-path">Fetching from Airtable...</div>
            <a id="pdf-fallback-link" target="_blank" style="display:none">Open File</a>
        </div>
    </div>
</div>

<script>
// --- SCHEMATICai v9.3 (THE AI PIPELINE) ---

// 1. PDF CONTROLLER
class PdfController {
    static load(id, url) {
        const frame = document.getElementById('pdf-viewer-frame');
        const place = document.getElementById('pdf-placeholder-text');
        const fallback = document.getElementById('pdf-fallback');
        const link = document.getElementById('pdf-fallback-link');

        place.style.display = 'none';
        frame.style.display = 'none';
        fallback.style.display = 'block';

        if (url) {
            frame.src = url;
            frame.style.display = 'block';
            fallback.style.display = 'none';
        }
        if(link) link.href = url || "#";
    }
}

// ‚ö†Ô∏è CREDENTIALS
const AIRTABLE_PAT = 'patNuv7rNHCIHeq5t.093ee4623c468319b352d024b4c2309fe598d7962dd83d481ec6b23b4cdacf99'; 
const AT_BASE = 'appgc1pbuOgmODRpj';
const AT_TABLE = 'Control Panel Items';
const AT_FEEDBACK = 'Feedback';

const VOTE_THRESHOLD = 3;

// 2. TRAINING DATA (From database.js)
const AI_TRAINING_DATA = { 
    MANUFACTURERS: { 'gorman rupp':['gorman','gr'], 'barnes':['barnes','sithe'], 'hydromatic':['hydromatic','hydro-matic'], 'flygt':['flygt'], 'myers':['myers'], 'goulds':['goulds'], 'zoeller':['zoeller'], 'liberty':['liberty'], 'wilo':['wilo'], 'pentair':['pentair'], 'abs':['abs'], 'aurora':['aurora'] }, 
    DATA: { HP: [0.5, 0.75, 1, 1.5, 2, 3, 5, 6.2, 7.5, 10, 15, 20, 25, 30, 40, 50, 60, 75, 100], VOLT: [120, 208, 240, 480, 575], PHASE: [1, 3] } 
};

// 3. THE HEALER (Manages Votes & Overrides)
class TheHealer {
    static healedData = {}; // Stores confirmed corrections

    static async fetchAndTally() {
        console.log("üöë Healer: Analyzing Feedback...");
        const tallies = {}; 

        try {
            let offset = null;
            do {
                const url = `https://api.airtable.com/v0/${AT_BASE}/${AT_FEEDBACK}?pageSize=100${offset ? '&offset='+offset : ''}`;
                const resp = await fetch(url, { headers: { 'Authorization': `Bearer ${AIRTABLE_PAT}` } });
                const data = await resp.json();
                
                if(!data.records) break;

                data.records.forEach(r => {
                    const id = r.fields['Panel ID'];
                    const param = r.fields['Parameter'];
                    const value = r.fields['Suggested Value'];
                    
                    if(id && param && value) {
                        const key = `${id}|${param}|${value}`;
                        tallies[key] = (tallies[key] || 0) + 1;
                    }
                });
                offset = data.offset;
            } while (offset);

            // Apply Corrections if threshold met
            for (const [key, count] of Object.entries(tallies)) {
                if (count >= VOTE_THRESHOLD) {
                    const [id, param, value] = key.split('|');
                    if (!this.healedData[id]) this.healedData[id] = {};
                    this.healedData[id][param] = value;
                    console.log(`‚ú® HEALED: ${id} ${param} = ${value} (${count} votes)`);
                }
            }
            console.log("‚úÖ Healer: Database Patched.");

        } catch(e) { console.error("Healing Failed", e); }
    }
}

// 4. AI PARSER (Engine)
class AIParser {
    static parse(text, panelId) {
        // Step 1: Check if Healer has a fix
        const healed = TheHealer.healedData[panelId];
        
        // Start with Healed values if they exist, otherwise null
        const specs = { 
            mfg: healed?.mfg || null, 
            hp: healed?.hp || null, 
            volt: healed?.volt || null, 
            phase: healed?.phase || null 
        };
        
        const t = (text || "").toUpperCase();

        // Step 2: Use Training Data for anything NOT healed
        if (!specs.mfg) {
            for (const [standard, aliases] of Object.entries(AI_TRAINING_DATA.MANUFACTURERS)) {
                const pattern = new RegExp(`\\b(${aliases.join('|').toUpperCase()})\\b`, 'i');
                if (pattern.test(t)) { specs.mfg = standard.toUpperCase(); break; }
            }
        }

        if (!specs.hp) {
            const hpMatch = t.match(/(\d+(?:\.\d+)?)\s*HP\b/i); 
            if(hpMatch) {
                const val = parseFloat(hpMatch[1]);
                if (!isNaN(val) && val < 999) specs.hp = hpMatch[1].replace(/\s/g, '');
            }
        }

        if (!specs.volt) {
            const voltMatch = t.match(/\b(115|120|208|230|240|277|460|480|575)\s*V(?:olt)?(?:age)?\b/i);
            if(voltMatch) specs.volt = voltMatch[1];
        }

        if (!specs.phase) {
            if (t.includes("3 PHASE") || t.includes("3PH") || t.includes("3-PH") || t.includes("3√ò")) specs.phase = "3";
            else if (t.includes("1 PHASE") || t.includes("1PH") || t.includes("1-PH") || t.includes("1√ò")) specs.phase = "1";
        }

        return specs;
    }
}

// 5. GLOBAL STORE
window.LOCAL_DB = [];
window.DB_IDS = new Set();

// 6. DATA LOADER (PIPELINE COORDINATOR)
class DataLoader {
    static async preload() {
        const btn = document.getElementById('searchBtn');
        btn.innerText = "INITIALIZING AI...";
        
        // 1. Run Healing Service
        await TheHealer.fetchAndTally();

        // 2. Fetch Main Data (Twin Turbo)
        btn.innerText = "DOWNLOADING DB...";
        const t1 = this.syncThread('desc'); 
        const t2 = this.syncThread('asc');  
        
        await Promise.all([t1, t2]);
        
        console.log(`‚úÖ Pipeline Complete: ${window.LOCAL_DB.length} records processed.`);
        btn.innerText = "SEARCH DATABASE";
        btn.disabled = false;
        btn.style.backgroundColor = "#461D7C";
    }

    static async syncThread(direction) {
        let offset = null;
        const fields = "&fields[]=Control Panel Name&fields[]=Items&fields[]=Control Panel PDF";
        
        try {
            do {
                if (window.LOCAL_DB.length >= 7500) break;

                const url = `https://api.airtable.com/v0/${AT_BASE}/${encodeURIComponent(AT_TABLE)}?pageSize=100${fields}${offset ? '&offset='+offset : ''}&sort%5B0%5D%5Bfield%5D=Control%20Panel%20Name&sort%5B0%5D%5Bdirection%5D=${direction}`;
                const resp = await fetch(url, { headers: { 'Authorization': `Bearer ${AIRTABLE_PAT}` } });
                const data = await resp.json();
                
                if(!data.records || data.records.length === 0) break;
                
                let newCount = 0;
                
                data.records.forEach(r => {
                    const id = r.fields['Control Panel Name'];
                    if (!window.DB_IDS.has(id)) {
                        window.DB_IDS.add(id);
                        newCount++;
                        const desc = r.fields['Items'] || "";
                        
                        // --- THE PIPELINE ---
                        // Raw -> AI Parser (With Healer Check) -> Result
                        const extracted = AIParser.parse(desc, id); 
                        
                        window.LOCAL_DB.push({
                            id: id,
                            desc: desc.toUpperCase(),
                            rawDesc: desc,
                            pdfUrl: (r.fields['Control Panel PDF'] && r.fields['Control Panel PDF'][0]) ? r.fields['Control Panel PDF'][0].url : null,
                            ...extracted
                        });
                    }
                });
                
                offset = data.offset;
                document.getElementById('searchBtn').innerText = `LOADING... (${window.LOCAL_DB.length})`;
                if (newCount === 0) break; 
                
            } while (offset);
        } catch(e) { console.error("Thread Error", e); }
    }

    static harvestCSV() {
        if (window.LOCAL_DB.length === 0) return alert("Wait for DB to load.");
        const headers = ["Panel Number", "Manufacturer", "HP", "Voltage", "Phase", "Description", "PDF Link"];
        const csv = [
            headers.join(','),
            ...window.LOCAL_DB.map(r => [r.id, r.mfg, r.hp, r.volt, r.phase, `"${r.rawDesc.replace(/"/g, '""')}"`, r.pdfUrl].join(','))
        ].join('\n');
        
        const blob = new Blob([csv], {type: 'text/csv'});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'golden_database.csv';
        link.click();
    }
}

// 7. SEARCH ENGINE
class SearchEngine {
    static perform() {
        if(window.LOCAL_DB.length === 0) return;

        const kw = document.getElementById('keywordInput').value.trim().toUpperCase();
        const mfg = document.getElementById('mfgInput').value;
        const hp = document.getElementById('hpInput').value;
        const volt = document.getElementById('voltInput').value;
        const phase = document.getElementById('phaseInput').value;

        if(!kw && mfg==="Any" && hp==="Any" && volt==="Any" && phase==="Any") {
            alert("Enter search criteria."); return;
        }

        const sortedDB = window.LOCAL_DB.sort((a, b) => (a.id < b.id) ? 1 : -1);

        const results = sortedDB.filter((rec) => {
            let pass = true;

            if(kw) {
                const searchTarget = (rec.id + " " + rec.desc).toUpperCase();
                if(!searchTarget.includes(kw)) { pass = false; }
            }
            if(pass && mfg !== "Any") {
                if(rec.mfg && rec.mfg !== mfg.toUpperCase()) { pass = false; }
                if(!rec.mfg && !rec.desc.includes(mfg.toUpperCase())) { pass = false; }
            }
            if(pass && hp !== "Any") {
                const hpStr = String(hp);
                const badgeMatch = rec.hp === hpStr;
                const textMatch = rec.desc.includes(hpStr + "HP") || rec.desc.includes(hpStr + " HP");
                if(!badgeMatch && !textMatch) { pass = false; }
            }
            if(pass && volt !== "Any") {
                const vStr = String(volt);
                const badgeMatch = rec.volt && rec.volt.includes(vStr);
                const textMatch = rec.desc.includes(vStr);
                if(!badgeMatch && !textMatch) { pass = false; }
            }
            if(pass && phase !== "Any") {
                const pStr = String(phase);
                const badgeMatch = rec.phase === pStr;
                const textMatch = rec.desc.includes(pStr + "PH") || rec.desc.includes(pStr + " PH");
                if(!badgeMatch && !textMatch) { pass = false; }
            }
            return pass;
        });

        UI.renderResults(results, { mfg, hp, volt, phase });
    }
}

// 8. UI
class UI {
    static toggleDarkMode() { document.body.classList.toggle('dark-mode'); }
    static handleEnter(e) { if(e.key==='Enter') SearchEngine.perform(); }
    static resetSearch() { 
        document.getElementById('keywordInput').value=''; 
        document.querySelectorAll('select').forEach(s => s.value = "Any"); 
        document.getElementById('results-area').innerHTML=''; 
    }
    
    static renderResults(results, criteria) { 
        const area = document.getElementById('results-area'); 
        area.innerHTML = ''; 
        
        const countDiv = document.createElement('div');
        countDiv.style.cssText = "font-size:12px; color:var(--text-secondary); margin-bottom:10px; padding:0 5px;";
        countDiv.innerText = `Found ${results.length} records`;
        area.appendChild(countDiv);

        if (results.length === 0) { area.innerHTML += '<div style="padding:20px; text-align:center; opacity:0.5;">No results found.</div>'; return; }

        results.slice(0, 100).forEach(item => {
            const card = document.createElement('div');
            card.className = 'record-card';
            
            const state = FeedbackService.history[item.id] || { up: false, downReasons: new Set() };
            const healed = TheHealer.healedData[item.id];
            
            let badges = '';
            
            // 1. MFG
            if(criteria.mfg !== "Any") {
               const isHealed = healed && healed.mfg;
               badges += `<span class="hud-badge ${isHealed ? 'match-healed' : 'match-exact'}">${criteria.mfg}</span>`;
            } 
            
            // 2. HP
            if(criteria.hp !== "Any" && criteria.hp !== "") {
                const isHealed = healed && healed.hp;
                badges += `<span class="hud-badge ${isHealed ? 'match-healed' : 'match-exact'}">${criteria.hp} HP</span>`;
            }
            
            // 3. Volt
            if(criteria.volt !== "Any" && criteria.volt !== "") {
                const isHealed = healed && healed.volt;
                badges += `<span class="hud-badge ${isHealed ? 'match-healed' : 'match-exact'}">${criteria.volt}V</span>`;
            }
            
            // 4. Phase
            if(criteria.phase !== "Any" && criteria.phase !== "") {
                const isHealed = healed && healed.phase;
                badges += `<span class="hud-badge ${isHealed ? 'match-healed' : 'match-exact'}">${criteria.phase}PH</span>`;
            }

            card.innerHTML = `
                <div class="card-header">
                    <div class="panel-name">${item.id ? item.id.replace('.dwg','') : "Unknown ID"}</div>
                </div>
                <div class="badge-row">${badges}</div>
                <div class="card-actions">
                    <button class="thumb-btn up ${state.up ? 'voted-up' : ''}" onclick="event.stopPropagation(); FeedbackService.up('${item.id}')">üëç</button>
                    <button class="thumb-btn down ${state.downReasons.size > 0 ? 'voted-down' : ''}" onclick="event.stopPropagation(); FeedbackService.down('${item.id}')">üëé</button>
                </div>
            `;
            
            card.onclick = () => {
                document.querySelectorAll('.record-card').forEach(c => c.classList.remove('active-view'));
                card.classList.add('active-view');
                PdfController.load(item.id, item.pdfUrl);
            };
            area.appendChild(card);
        });
    }

    static populateDropdowns() {
        ['mfg', 'hp', 'volt', 'phase'].forEach(cat => {
            const sel = document.getElementById(cat+'Input');
            if(!sel) return;
            const items = cat === 'mfg' ? Object.keys(AI_TRAINING_DATA.MANUFACTURERS) : AI_TRAINING_DATA.DATA[cat.toUpperCase()];
            items.forEach(i => {
                const opt = document.createElement('option');
                opt.value = i; 
                opt.innerText = i;
                sel.appendChild(opt);
            });
        });
    }
}

// 9. FEEDBACK SERVICE
class FeedbackService {
    static history = {};
    static activeId = null;
    
    static down(id) {
        this.activeId = id;
        this.history[id] = this.history[id] || { up: false, downReasons: new Set() };
        
        document.querySelectorAll('.correction-input').forEach(i => i.value = '');
        document.querySelectorAll('.reason-btn').forEach(b => b.classList.remove('selected', 'locked'));
        
        if(this.history[id].downReasons) {
            this.history[id].downReasons.forEach(r => {
                const btn = document.querySelector(`.reason-btn[data-reason="${r}"]`);
                if(btn) btn.classList.add('locked');
            });
        }
        
        document.getElementById('feedback-modal').classList.add('active-modal');
    }
    
    static async submit() {
        const id = this.activeId;
        const submissions = [];
        
        document.querySelectorAll('.reason-btn.selected').forEach(btn => {
            const reasonCode = btn.dataset.reason;
            const input = btn.nextElementSibling; 
            const value = input && input.classList.contains('correction-input') ? input.value : "";
            
            if(value) {
                submissions.push({ id, reasonCode, value });
                this.history[id].downReasons.add(reasonCode);
            }
        });
        
        if(submissions.length === 0) return alert("Select a reason and enter a value.");

        for(const sub of submissions) {
            await this.sendToAirtable(sub.id, sub.reasonCode, sub.value);
        }
        
        alert("Votes Recorded. Thank you.");
        const cardBtn = document.querySelector(`.thumb-btn.down[onclick*="${id}"]`);
        if(cardBtn) cardBtn.classList.add('voted-down');
        
        this.close();
    }
    
    static async sendToAirtable(panelId, param, value) {
        const url = `https://api.airtable.com/v0/${AT_BASE}/${AT_FEEDBACK}`;
        const data = {
            "fields": {
                "Panel ID": panelId,
                "Parameter": param,
                "Suggested Value": value
            }
        };
        await fetch(url, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${AIRTABLE_PAT}`, 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
    }
    
    static toggleReason(el) { if(!el.classList.contains('locked')) el.classList.toggle('selected'); }
    static close() { document.getElementById('feedback-modal').classList.remove('active-modal'); }
    static up(id) { alert("Liked!"); } 
}

class ConfigService { static reset() { if(confirm("Reset?")) { localStorage.clear(); location.reload(); } } }

class AuthService {
    static init() { 
        const session = JSON.parse(localStorage.getItem('cox_auth_session'));
        if (session && session.expiry > Date.now()) { 
            document.documentElement.classList.add('logged-in'); 
            return true; 
        } 
        document.getElementById('auth-overlay').classList.add('active-modal');
        return false; 
    }
    static login() { 
        const user = document.getElementById('auth-user').value; if(!user) return;
        localStorage.setItem('cox_auth_session', JSON.stringify({ user, expiry: Date.now() + 86400000 })); location.reload(); 
    }
    static logout() { localStorage.removeItem('cox_auth_session'); location.reload(); }
}

class App {
    static init() {
        AuthService.init();
        UI.populateDropdowns();
        DataLoader.preload(); 
    }
}

document.addEventListener('DOMContentLoaded', App.init);
</script>
</body>
</html>