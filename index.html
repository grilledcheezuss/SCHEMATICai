<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cox Research | SCHEMATICai (v6.1 - Bayes Restored)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <script type="module" src="database.js"></script>

    <script>
        try {
            const session = JSON.parse(localStorage.getItem('cox_auth_session'));
            if (session && session.expiry > Date.now()) {
                document.documentElement.classList.add('logged-in');
            }
        } catch(e) {}
    </script>
    
    <style>
        :root { 
            --app-primary: #461D7C;        
            --bg-app: #e3e5e8; 
            --bg-sidebar: #ffffff; 
            --bg-card: #ffffff;
            --bg-controls: rgba(255,255,255,0.98); 
            --bg-viewer: #323639; 
            --bg-input: #ffffff;
            --text-primary: #121212; 
            --text-secondary: #5f6368; 
            --border-color: #c7c7cc; 
            
            --match-exact-bg: #dcfce7; --match-exact-text: #166534; 
            --match-varied-bg: #ffedd5; --match-varied-text: #c2410c; 
            --badge-default-bg: #f3f4f6; --badge-default-text: #374151; 
            
            --header-height: 80px; 
            --input-height: 48px;
            color-scheme: light; 
        }

        body.dark-mode {
            --bg-app: #121212; --bg-sidebar: #1e1e1e; --bg-card: #2d2d2d; 
            --bg-controls: rgba(30, 30, 30, 0.98); --bg-viewer: #1a1a1a; 
            --bg-input: #383838; 
            --text-primary: #e8eaed; --text-secondary: #9aa0a6; 
            --border-color: #3c4043;
            
            --match-exact-bg: #14532d; --match-exact-text: #86efac; 
            --match-varied-bg: #7c2d12; --match-varied-text: #fdba74; 
            --badge-default-bg: #374151; --badge-default-text: #e5e7eb;
            color-scheme: dark;            
        }
        
        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; background-color: var(--bg-app); color: var(--text-primary); height: 100vh; display: flex; flex-direction: column; overflow: hidden; font-size: 15px; }

        header { background: linear-gradient(135deg, #461D7C 0%, #2e0e57 100%); height: var(--header-height); padding: 0 25px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 100; flex-shrink: 0; position: relative; }
        .logo-group { text-decoration: none; display: flex; flex-direction: column; line-height: 1; z-index: 2; }
        .logo-main { font-family: 'Helvetica Neue', Arial, sans-serif; font-size: 2.2rem; font-weight: 900; color: white; letter-spacing: -1px; text-transform: uppercase; }
        .logo-sub { font-family: 'Helvetica Neue', Arial, sans-serif; font-size: 0.75rem; color: #b39ddb; font-weight: 700; letter-spacing: 4px; text-transform: uppercase; margin-top: 4px; }
        
        .version-badge { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.3); color: white; padding: 6px 16px; border-radius: 20px; font-weight: 800; font-size: 13px; letter-spacing: 1px; white-space: nowrap; pointer-events: none; }

        .header-controls { display: flex; align-items: center; gap: 12px; margin-left: auto; z-index: 2; }
        .control-btn { background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.3); color: white; width: 42px; height: 42px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; transition: all 0.2s; overflow: hidden; }
        .btn-bug { font-size: 14px; }

        #app-container { display: none; flex: 1; overflow: hidden; height: calc(100vh - var(--header-height)); }
        html.logged-in #app-container { display: flex !important; }
        
        #sidebar { width: 420px; min-width: 320px; background: var(--bg-sidebar); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; z-index: 20; }
        .sidebar-controls { padding: 15px; background: var(--bg-controls); border-bottom: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 10px; }
        
        .filter-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .input-group { display: flex; flex-direction: column; gap: 2px; }
        .input-label { font-size: 10px; font-weight: 800; text-transform: uppercase; color: var(--text-secondary); }
        .cox-input { width: 100%; height: var(--input-height); padding: 0 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; background: var(--bg-input); color: var(--text-primary); outline: none; }
        .search-btn { flex: 1; height: 40px; background-color: #461D7C !important; color: white !important; border: none; border-radius: 6px; font-weight: 800; cursor: pointer; }
        .reset-btn { height: 40px; width: 40px; background: var(--bg-app); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; }

        #results-scroll-area { flex: 1; overflow-y: auto; padding: 15px; background: var(--bg-app); }
        #results-area { display: flex; flex-direction: column; gap: 8px; padding-bottom: 80px; }

        .record-card { background: var(--bg-card); padding: 12px 15px; border-radius: 8px; border: 1px solid var(--border-color); border-left: 6px solid var(--app-primary); box-shadow: 0 1px 3px rgba(0,0,0,0.05); cursor: pointer; position: relative; transition: all 0.2s; display: flex; flex-direction: column; gap: 10px; }
        .record-card:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .record-card.active-view { background: rgba(70, 29, 124, 0.03); border-color: var(--app-primary); }
        
        .card-header { display: flex; justify-content: space-between; align-items: center; }
        .panel-name { font-size: 24px; font-weight: 900; color: var(--app-primary); margin: 0; letter-spacing: -0.5px; }

        .badge-row { display: flex; gap: 6px; flex-wrap: wrap; }
        .hud-badge { font-size: 11px; font-weight: 800; text-transform: uppercase; padding: 4px 10px; border-radius: 6px; letter-spacing: 0.5px; border: 1px solid transparent; background: var(--badge-default-bg); color: var(--badge-default-text); }
        .hud-badge.match-exact { background: var(--match-exact-bg); color: var(--match-exact-text); border-color: var(--match-exact-border); }
        .hud-badge.match-varied { background: var(--match-varied-bg); color: var(--match-varied-text); border-color: var(--match-varied-border); }

        .card-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 4px; border-top: 1px solid var(--border-color); padding-top: 8px; }
        .thumb-btn { background: transparent; border: 1px solid var(--border-color); border-radius: 4px; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; transition: 0.2s; }
        .thumb-btn:hover { background: #f5f5f5; }

        #auth-overlay, #feedback-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(4px); z-index: 10000; align-items: center; justify-content: center; }
        .active-modal { display: flex !important; }
        
        .auth-card { background: var(--bg-card); padding: 40px; border-radius: 12px; width: 100%; max-width: 400px; text-align: center; }
        .modal-card { width: 400px; background: var(--bg-card); border-radius: 12px; overflow: hidden; border: 1px solid var(--border-color); }
        .modal-header { background: var(--app-primary); padding: 15px; display: flex; justify-content: space-between; align-items: center; color: white; font-weight: 700; }
        .modal-content { padding: 20px; }
        
        .reason-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .reason-btn { padding: 10px; border: 1px solid var(--border-color); background: var(--bg-input); color: var(--text-primary); border-radius: 6px; cursor: pointer; text-align: center; font-size: 12px; font-weight: 600; }
        .reason-btn.selected { background: var(--status-error); color: white; border-color: var(--status-error); }
        .submit-feedback-btn { width: 100%; padding: 12px; background: var(--app-primary); color: white; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; }

        #preview-pane { flex: 1; background: var(--bg-viewer); display: flex; flex-direction: column; align-items: center; justify-content: center; color: rgba(255,255,255,0.5); font-size: 20px; position:relative; overflow: hidden; }
        #pdf-viewer-frame { width: 100%; height: 100%; border: none; background: #fff; }
        .pdf-fallback { display: none; text-align: center; color: white; padding: 20px; }
        .pdf-fallback a { display: inline-block; margin-top: 10px; color: #b39ddb; text-decoration: underline; font-size: 14px; cursor: pointer; }
        
        @media (max-width: 900px) { #sidebar { width: 100%; } #preview-pane { display: none; } }
    </style>
</head>
<body>

<div id="auth-overlay">
    <div class="auth-card">
        <h2 style="color:var(--app-primary); margin-top:0;">SCHEMATICai</h2>
        <input type="text" id="auth-user" class="cox-input" placeholder="Username" style="margin-bottom:10px;">
        <button class="submit-feedback-btn" onclick="AuthService.login()">Authenticate</button>
    </div>
</div>

<header>
    <a href="#" class="logo-group">
        <span class="logo-main">COX</span>
        <span class="logo-sub">RESEARCH</span>
    </a>
    <div class="version-badge">SCHEMATICai v6.1</div>
    <div class="header-controls">
        <button class="control-btn btn-bug" onclick="FeedbackService.down(null)">üêû</button>
        <button class="control-btn" onclick="UI.toggleDarkMode()">üåì</button>
        <button class="control-btn" onclick="AuthService.logout()">‚èª</button>
    </div>
</header>

<div id="feedback-modal">
    <div class="modal-card">
        <div class="modal-header">
            <span>Report Inaccuracy</span>
            <button class="control-btn" style="width:24px;height:24px;font-size:12px;background:rgba(255,255,255,0.2);" onclick="FeedbackService.close()">X</button>
        </div>
        <div class="modal-content">
            <p style="margin-top:0; font-size:13px; color:var(--text-secondary);">Select all that apply:</p>
            <div class="reason-grid">
                <div class="reason-btn" onclick="FeedbackService.toggleReason(this, 'mfg')">Wrong Manufacturer</div>
                <div class="reason-btn" onclick="FeedbackService.toggleReason(this, 'hp')">Wrong HP</div>
                <div class="reason-btn" onclick="FeedbackService.toggleReason(this, 'volt')">Wrong Voltage</div>
                <div class="reason-btn" onclick="FeedbackService.toggleReason(this, 'phase')">Wrong Phase</div>
                <div class="reason-btn" onclick="FeedbackService.toggleReason(this, 'enc')">Wrong Enclosure</div>
                <div class="reason-btn" onclick="FeedbackService.toggleReason(this, 'dup')">Duplicate Record</div>
            </div>
            <button class="submit-feedback-btn" onclick="FeedbackService.submit()">SUBMIT FEEDBACK</button>
        </div>
    </div>
</div>

<div id="app-container">
    <div id="sidebar">
        <div class="sidebar-controls">
            <div class="input-group"><span class="input-label">Keywords</span><input type="text" id="keywordInput" class="cox-input" placeholder="e.g. Duplex, 1PH, CP-7920" onkeypress="UI.handleEnter(event)"></div>
            <div class="filter-grid">
                <div class="input-group"><span class="input-label">Manufacturer</span><select id="mfgInput" class="cox-input"><option value="">Any</option></select></div>
                <div class="input-group"><span class="input-label">Phase</span><select id="phaseInput" class="cox-input"><option value="">Any</option></select></div>
                <div class="input-group"><span class="input-label">HP</span><select id="hpInput" class="cox-input"><option value="">Any</option></select></div>
                <div class="input-group"><span class="input-label">Voltage</span><select id="voltInput" class="cox-input"><option value="">Any</option></select></div>
            </div>
            <div style="display:flex; gap:8px; margin-top:5px;">
                <button class="reset-btn" onclick="UI.resetSearch()">‚Ü∫</button>
                <button class="search-btn" id="searchBtn" onclick="SearchEngine.perform()">SEARCH</button>
            </div>
        </div>
        <div id="results-scroll-area"><div id="results-area"></div></div>
    </div>
    <div id="preview-pane">
        <div id="pdf-placeholder-text">üìÑ Select a schematic to view</div>
        <iframe id="pdf-viewer-frame" style="display:none;"></iframe>
        <div id="pdf-fallback" class="pdf-fallback">
            <div style="margin-bottom:10px;">‚ö†Ô∏è PDF Not Found (404)</div>
            <div style="font-size:12px; opacity:0.7;" id="pdf-debug-path"></div>
            <a id="pdf-fallback-link" target="_blank">Try opening in new tab</a>
        </div>
    </div>
</div>

<script>
// --- SCHEMATICai v6.1 (AI RESTORED) ---

// 1. THE HEALING DATABASE (Simulated User Feedback)
const HealingDB = {
    // Force specific corrections known to be bad data
    "CP-6950": { mfg: "GORMAN RUPP" }, // Blocks it from Barnes search
    "CP-2801": { mfg: "GORMAN RUPP", phase: "3" } 
};

// 2. NAIVE BAYES CLASSIFIER (The "Brain")
class BayesClassifier {
    constructor() {
        this.trained = false;
        this.termProbability = {};
    }
    
    // Scans database to learn term associations
    train(records) {
        console.log("üß† AI Training Initiated...");
        records.forEach(rec => {
            const tokens = (rec.keys + " " + rec.mfg).toLowerCase().split(/\s+/);
            const label = rec.mfg || "UNKNOWN";
            
            tokens.forEach(t => {
                if(!this.termProbability[t]) this.termProbability[t] = {};
                if(!this.termProbability[t][label]) this.termProbability[t][label] = 0;
                this.termProbability[t][label]++;
            });
        });
        this.trained = true;
        console.log("üß† AI Training Complete.");
    }

    // Returns probability of a record matching a specific category (e.g. Mfg)
    predict(record, category, value) {
        if(!this.trained) return 0.5;
        // Simple probability check for now: Does the text strictly imply the value?
        const text = (record.keys + " " + record.mfg).toUpperCase();
        const val = String(value).toUpperCase();
        
        if (text.includes(val)) return 0.9; // High confidence
        return 0.1;
    }
}

const AI = new BayesClassifier();

const STORAGE_KEYS = { SESSION: 'cox_auth_session' };
const CONSTANTS = { 
    MANUFACTURERS: { 'gorman rupp':['gorman','gr'], 'barnes':['barnes','sithe'], 'hydromatic':['hydromatic','hydro-matic'], 'flygt':['flygt'], 'myers':['myers'], 'goulds':['goulds'], 'zoeller':['zoeller'], 'liberty':['liberty'], 'wilo':['wilo'], 'pentair':['pentair'], 'abs':['abs'], 'aurora':['aurora'] }, 
    DATA: { HP: [0.5, 0.75, 1, 1.5, 2, 3, 5, 6.2, 7.5, 10, 15, 20, 25, 30, 40, 50, 60, 75, 100], VOLT: [120, 208, 240, 480, 575], PHASE: [1, 3] } 
};

class AuthService {
    static init() { 
        const session = JSON.parse(localStorage.getItem(STORAGE_KEYS.SESSION)); 
        if (session && session.expiry > Date.now()) { document.documentElement.classList.add('logged-in'); return true; } 
        document.getElementById('auth-overlay').classList.add('active-modal');
        return false; 
    }
    static login() { 
        const user = document.getElementById('auth-user').value; if(!user) return;
        localStorage.setItem(STORAGE_KEYS.SESSION, JSON.stringify({ user, expiry: Date.now() + 86400000 })); location.reload(); 
    }
    static logout() { localStorage.removeItem(STORAGE_KEYS.SESSION); location.reload(); }
}

class DatabaseService {
    static allRecords = []; 
    static async init() { 
        if(window.LOCAL_PANEL_DATA) this.allRecords = window.LOCAL_PANEL_DATA; 
        console.log("DB Loaded:", this.allRecords.length);
        AI.train(this.allRecords);
    }
}

class PdfController {
    static load(id) {
        const frame = document.getElementById('pdf-viewer-frame');
        const place = document.getElementById('pdf-placeholder-text');
        const fallback = document.getElementById('pdf-fallback');
        const link = document.getElementById('pdf-fallback-link');
        const debug = document.getElementById('pdf-debug-path');

        place.style.display = 'none';
        fallback.style.display = 'block'; 
        frame.style.display = 'block';
        
        // V6.1 ROOT PATH
        const path = `/${id}.pdf`; 
        frame.src = path; 
        link.href = path; 
        link.innerText = `Open ${id}.pdf in new tab`;
        debug.innerText = `Looking for: ${path}`;
    }
}

class FeedbackService {
    static activeId = null;
    static selectedReasons = new Set();
    static up(id) { alert(`Recorded: Thumbs UP for CP-${id}`); }
    static down(id) { 
        this.activeId = id || "General"; 
        this.selectedReasons.clear();
        document.querySelectorAll('.reason-btn').forEach(b => b.classList.remove('selected'));
        document.getElementById('feedback-modal').classList.add('active-modal');
    }
    static toggleReason(el, reason) {
        el.classList.toggle('selected');
        if(this.selectedReasons.has(reason)) this.selectedReasons.delete(reason); else this.selectedReasons.add(reason);
    }
    static submit() {
        alert(`Feedback Sent for CP-${this.activeId}: ${Array.from(this.selectedReasons).join(', ') || "Issue Report"}`);
        this.close();
    }
    static close() { document.getElementById('feedback-modal').classList.remove('active-modal'); }
}

class SearchEngine {
    static perform() { 
        const criteria = {
            kw: document.getElementById('keywordInput').value.trim(),
            mfg: document.getElementById('mfgInput').value,
            hp: document.getElementById('hpInput').value,
            volt: document.getElementById('voltInput').value,
            phase: document.getElementById('phaseInput').value
        };

        if(!criteria.kw && !criteria.mfg && !criteria.hp && !criteria.volt && !criteria.phase) { 
            alert("Enter keywords or select filters."); return; 
        }

        const btn = document.getElementById('searchBtn');
        btn.innerText = "...";
        setTimeout(() => { 
            const results = this.runQuery(criteria);
            UI.renderResults(results, criteria);
            btn.innerText = "SEARCH";
        }, 50);
    }

    static runQuery(c) {
        if (!DatabaseService.allRecords.length) return [];
        
        let matches = [];
        DatabaseService.allRecords.forEach(rec => {
            // 1. APPLY HEALING (User Corrections)
            let correctedRec = { ...rec, ...HealingDB[rec.id] };

            let matchData = {}; 
            let isFail = false;
            let variedCount = 0;
            let exactCount = 0;
            let totalFilters = 0;
            
            const checkField = (dbVal, searchVal, patterns, isConflictCheck) => {
                const s = String(searchVal || "").toUpperCase();
                const d = String(dbVal || "").toUpperCase();
                const desc = (correctedRec.keys || "").toUpperCase();
                
                // HARD CONFLICT VETO
                if (isConflictCheck && d !== "" && !d.includes(s)) return 'conflict';

                if (d === s) return 'exact';
                if (d.includes(s) && d !== "") return 'varied';
                
                // AI INFERENCE (Fallback if blank)
                if (d === "") {
                    // Try pattern matching (Regex)
                    if (patterns.some(p => desc.includes(p.toUpperCase()))) return 'exact';
                    
                    // Ask AI
                    const prob = AI.predict(correctedRec, 'mfg', searchVal);
                    if (prob > 0.8) return 'exact';
                }
                return 'fail';
            };

            // 1. MFG - CONFLICT FIX
            if (c.mfg && c.mfg !== "Any") {
                totalFilters++;
                const res = checkField(correctedRec.mfg, c.mfg, [c.mfg], true);
                if (res === 'conflict') { isFail = true; } 
                else if (res !== 'fail') { matchData.mfg = res; if(res==='exact') exactCount++; else variedCount++; }
                else isFail = true; 
            }

            // 2. HP
            if (c.hp && c.hp !== "Any") {
                totalFilters++;
                const res = checkField(correctedRec.hp, c.hp, [c.hp+"HP", c.hp+" HP", c.hp+"-HP"], false);
                if (res !== 'fail') { matchData.hp = res; if(res==='exact') exactCount++; else variedCount++; }
                else isFail = true;
            }

            // 3. Volt
            if (c.volt && c.volt !== "Any") {
                totalFilters++;
                const res = checkField(correctedRec.volt, c.volt, [c.volt+"V", c.volt+" V", c.volt+"VOLT"], false);
                if (res !== 'fail') { matchData.volt = res; if(res==='exact') exactCount++; else variedCount++; }
                else isFail = true;
            }

            // 4. Phase
            if (c.phase && c.phase !== "Any") {
                totalFilters++;
                const s = String(c.phase);
                let patterns = [s+"PH", s+"-PH", s+" PHASE"];
                if (s === "1") patterns.push("SINGLE PHASE", "SINGLE-PHASE", "1-PHASE");
                if (s === "3") patterns.push("THREE PHASE", "THREE-PHASE", "3-PHASE");

                const res = checkField(correctedRec.phase, c.phase, patterns, false);
                if (res !== 'fail') { matchData.phase = res; if(res==='exact') exactCount++; else variedCount++; }
                else isFail = true;
            }

            if (c.kw) {
                const allText = (correctedRec.keys + " " + correctedRec.mfg + " " + correctedRec.id).toUpperCase();
                if (!allText.includes(c.kw.toUpperCase())) isFail = true;
            }

            if (!isFail) {
                let tier = 3; 
                if (exactCount === totalFilters && totalFilters > 0) tier = 0; 
                else if (c.hp && matchData.hp === 'varied' && variedCount === 1) tier = 1; 
                else if (variedCount === 1) tier = 2; 

                matches.push({ rec: correctedRec, matchData, tier });
            }
        });

        return matches.sort((a, b) => {
            if (a.tier !== b.tier) return a.tier - b.tier; 
            return parseInt(b.rec.id) - parseInt(a.rec.id); 
        });
    }
}

class UI {
    static toggleDarkMode() { document.body.classList.toggle('dark-mode'); }
    static handleEnter(e) { if(e.key==='Enter') SearchEngine.perform(); }
    static resetSearch() { 
        document.getElementById('keywordInput').value=''; 
        document.querySelectorAll('select').forEach(s => s.value = "");
        document.getElementById('results-area').innerHTML=''; 
    }
    
    static cleanMfg(raw) {
        if(!raw) return "";
        const r = raw.toUpperCase();
        for(const [k, v] of Object.entries(CONSTANTS.MANUFACTURERS)) {
            if(r.includes(k.toUpperCase()) || v.some(x => r.includes(x.toUpperCase()))) return k.toUpperCase();
        }
        return raw;
    }

    static renderResults(results, criteria) { 
        const area = document.getElementById('results-area'); 
        area.innerHTML = ''; 
        if (!results || !results.length) { area.innerHTML = '<div style="padding:20px; text-align:center; opacity:0.5;">No results found.</div>'; return; }

        results.forEach(item => {
            const rec = item.rec;
            const meta = item.matchData;
            const card = document.createElement('div');
            card.className = 'record-card';
            
            const displayMfg = UI.cleanMfg(rec.mfg);
            let badges = '';

            // BADGE GENERATION: Shows Corrected/Inferred Data
            if(criteria.mfg && criteria.mfg !== "Any") {
                badges += `<span class="hud-badge ${meta.mfg ? 'match-'+meta.mfg : ''}">${displayMfg || "Unknown Mfg"}</span>`;
            }
            if(criteria.hp && criteria.hp !== "Any") {
                badges += `<span class="hud-badge ${meta.hp ? 'match-'+meta.hp : ''}">${rec.hp || "HP?"} HP</span>`;
            }
            if(criteria.volt && criteria.volt !== "Any") {
                badges += `<span class="hud-badge ${meta.volt ? 'match-'+meta.volt : ''}">${rec.volt || "V?"}V</span>`;
            }
            if(criteria.phase && criteria.phase !== "Any") {
                badges += `<span class="hud-badge ${meta.phase ? 'match-'+meta.phase : ''}">${rec.phase || criteria.phase}PH</span>`;
            }

            card.innerHTML = `
                <div class="card-header">
                    <div class="panel-name">CP-${rec.id}</div>
                </div>
                <div class="badge-row">${badges}</div>
                <div class="card-actions">
                    <button class="thumb-btn up" onclick="event.stopPropagation(); FeedbackService.up('${rec.id}')">üëç</button>
                    <button class="thumb-btn down" onclick="event.stopPropagation(); FeedbackService.down('${rec.id}')">üëé</button>
                </div>
            `;
            
            card.onclick = () => {
                document.querySelectorAll('.record-card').forEach(c => c.classList.remove('active-view'));
                card.classList.add('active-view');
                PdfController.load(rec.id);
            };
            area.appendChild(card);
        });
    }

    static populateDropdowns() {
        ['mfg', 'hp', 'volt', 'phase'].forEach(cat => {
            const sel = document.getElementById(cat+'Input');
            if(!sel) return;
            const items = cat === 'mfg' ? Object.keys(CONSTANTS.MANUFACTURERS) : CONSTANTS.DATA[cat.toUpperCase()];
            items.forEach(i => {
                const opt = document.createElement('option');
                opt.value = String(i).toUpperCase(); opt.innerText = String(i).toUpperCase();
                sel.appendChild(opt);
            });
        });
    }
}

class App {
    static init() {
        AuthService.init();
        DatabaseService.init();
        UI.populateDropdowns();
    }
}

document.addEventListener('DOMContentLoaded', App.init);
</script>
</body>
</html>