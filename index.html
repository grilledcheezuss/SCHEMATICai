<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Cox Research | SCHEMATICA ai (v1.65)</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîí</text></svg>">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/@pdf-lib/fontkit@1.1.1/dist/fontkit.umd.min.js"></script>
    <script src="database.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div id="auth-overlay" class="active-modal">
    <div class="auth-card">
        <h2 style="color:var(--app-primary);">SCHEMATICA ai</h2>
        <form onsubmit="event.preventDefault(); AuthService.login();">
            <input type="text" id="auth-user" class="cox-input" placeholder="Username" style="margin-bottom:10px;" autocomplete="username">
            <input type="password" id="auth-pass" class="cox-input" placeholder="Passcode" style="margin-bottom:10px;" autocomplete="current-password">
            <button class="search-btn" type="submit">Authenticate</button>
        </form>
    </div>
</div>

<div id="feedback-modal">
    <div class="modal-card">
        <h3 style="color:var(--app-primary); margin-bottom:15px;">REPORT INACCURACY</h3>
        <p style="font-size:11px; color:var(--text-secondary); margin-bottom:15px;">Please select the <b style="color:var(--match-green-text); background:var(--match-green-bg); padding:1px 4px; border-radius:3px;">CORRECT</b> values.</p>
        <div class="feedback-grid">
            <div><span class="feedback-label">Correct Mfg</span><select id="fb-mfg" class="cox-input"></select></div>
            <div><span class="feedback-label">Correct HP</span><select id="fb-hp" class="cox-input"></select></div>
            <div><span class="feedback-label">Correct Volt</span><select id="fb-volt" class="cox-input"></select></div>
            <div><span class="feedback-label">Correct Phase</span><select id="fb-phase" class="cox-input"></select></div>
            <div style="grid-column: span 2;"><span class="feedback-label">Correct Enclosure</span><select id="fb-enc" class="cox-input"></select></div>
        </div>
        <div style="border-top:1px solid var(--border-color); padding-top:10px; margin-bottom:10px;">
             <button id="fb-low-volt-btn" class="keyword-toggle" style="width:100%; text-align:center; padding:8px;" onclick="this.classList.toggle('selected')">‚ö° Report as Low Voltage / Control Only</button>
        </div>
        <div id="keyword-feedback-area" style="display:none; border-top:1px solid var(--border-color); padding-top:10px;">
             <p style="font-size:11px; color:var(--text-secondary); margin-bottom:8px;">Incorrect Keyword Match?</p>
             <div id="keyword-cluster" class="keyword-cluster"></div>
        </div>
        <button class="search-btn" onclick="FeedbackService.submit()">SUBMIT CORRECTION</button>
        <button class="search-btn" style="background:#555; margin-top:5px;" onclick="FeedbackService.close()">Cancel</button>
    </div>
</div>

<header>
    <a href="#" class="logo-group"><span class="logo-main">COX</span><span class="logo-sub">RESEARCH</span></a>
    
    <div class="app-title-group">
        <span class="app-title-main">SCHEMATICA ai</span>
        <span class="app-title-version">v1.65</span>
    </div>

    <div class="header-controls">
        <button id="main-menu-btn" class="menu-btn" onclick="UI.toggleMenu()">‚ò∞</button>
        <div id="main-menu" class="menu-dropdown">
            <div class="menu-section" id="admin-tools-section">
                <div class="menu-header">Admin Tools</div>
                <button id="menu-demo" class="menu-item" onclick="DemoManager.toggleGenerator(); UI.toggleMenu()">
                    <span class="menu-icon">üìÑ</span> Submittal Generator <span id="gen-status" style="margin-left:auto; display:none;">‚óè</span>
                </button>
                <button class="menu-item" onclick="DataLoader.harvestCSV(); UI.toggleMenu()"><span class="menu-icon">üì•</span> Harvest CSV</button>
            </div>
            <div class="menu-section">
                <div class="menu-header">General</div>
                <button class="menu-item" onclick="UI.toggleDarkMode(); UI.toggleMenu()"><span class="menu-icon">üåì</span> Switch Theme</button>
                <button class="menu-item" onclick="DataLoader.resetSync(); UI.toggleMenu()"><span class="menu-icon">üîÑ</span> Force Reset</button>
                <button class="menu-item danger" onclick="AuthService.logout(); UI.toggleMenu()"><span class="menu-icon">‚èª</span> Logout</button>
            </div>
        </div>
    </div>
</header>

<div id="app-container">
    <div id="sidebar-left">
        <div id="search-controls" class="sidebar-controls">
            <div class="input-group">
                <span class="input-label">Keywords</span>
                <input type="text" id="keywordInput" class="cox-input" placeholder="e.g. Pump, Fan..." onkeypress="UI.handleEnter(event)">
            </div>
            <div class="filter-grid" style="margin-top:5px;">
                <div class="input-group"><span class="input-label">Manufacturer</span><select id="mfgInput" class="cox-input"><option value="Any">Any</option></select></div>
                <div class="input-group"><span class="input-label">Horsepower</span><select id="hpInput" class="cox-input"><option value="Any">Any</option></select></div>
                <div class="input-group"><span class="input-label">Voltage</span><select id="voltInput" class="cox-input"><option value="Any">Any</option></select></div>
                <div class="input-group"><span class="input-label">Phase</span><select id="phaseInput" class="cox-input"><option value="Any">Any</option></select></div>
                <div class="input-group full-width"><span class="input-label">Enclosure</span><select id="encInput" class="cox-input"><option value="Any">Any</option></select></div>
                <div class="input-group full-width">
                    <span class="input-label">Panel Type</span>
                    <select id="catInput" class="cox-input">
                        <option value="Standard">Standard</option>
                        <option value="LowVoltage">Low Voltage Only</option>
                        <option value="Any">Show All</option>
                    </select>
                </div>
            </div>
            <div style="display:flex; gap:8px; margin-top:8px;">
                <button class="reset-btn" onclick="UI.resetSearch()" title="Reset Filters">‚Ü∫</button>
                <button id="searchBtn" class="search-btn" onclick="SearchEngine.perform()" disabled>INITIALIZING...</button>
            </div>
        </div>
        <div id="refine-btn-area"><button class="refine-btn" onclick="UI.toggleSearch(true)">üîç REFINE SEARCH</button></div>
        <div id="results-scroll-area">
            <div id="results-area"></div>
        </div>
        
        <div id="pagination-footer">
            <button id="page-prev" class="page-btn" onclick="SearchEngine.prevPage()">‚Äπ Prev</button>
            <span id="page-info" class="page-info"></span>
            <button id="page-next" class="page-btn" onclick="SearchEngine.nextPage()">Next ‚Ä∫</button>
        </div>
    </div>
    
    <div id="toggle-left" class="collapse-btn" onclick="UI.toggleLeftSidebar()">‚Äπ</div>

    <div id="preview-pane">
        <div id="pdf-toolbar">
            <button class="pdf-tool-btn" onclick="PdfViewer.print()" title="Print PDF">üñ®Ô∏è</button>
            <button class="pdf-tool-btn" onclick="PdfViewer.zoom(-0.2)" title="Zoom Out">-</button>
            <span id="pdf-zoom-level">110%</span>
            <button class="pdf-tool-btn" onclick="PdfViewer.zoom(0.2)" title="Zoom In">+</button>
        </div>
        <div id="custom-pdf-viewer" style="display:none;"><div id="pdf-main-view"></div></div>
        <iframe id="pdf-viewer-frame" style="display:none;"></iframe>
        <div id="pdf-fallback" class="pdf-fallback">
            <div style="margin-bottom:10px;">‚ö†Ô∏è PDF Link Not Found</div>
            <a id="pdf-fallback-link" target="_blank">Open File</a>
        </div>
        <div id="pdf-placeholder-text">üìÑ Select a schematic</div>
    </div>

    <div id="generator-panel" style="display:none;">
        <div id="gen-drag-handle" class="editor-header" style="cursor: move;">
            <span class="editor-title">Generator Controls</span>
            <div class="panel-controls">
                <button class="panel-btn" onclick="DemoManager.minimizePanel()" title="Minimize to View">‚îÄ</button>
                <button class="panel-btn" onclick="DemoManager.toggleGenerator()" title="Close Generator">‚úñ</button>
            </div>
        </div>
        
        <div id="redaction-editor-content">
             
             <div class="editor-section" style="border-bottom:1px solid var(--border-color); padding-bottom:10px; margin-bottom:10px;">
                <div style="display:flex; gap:5px; margin-bottom:5px;">
                    <input type="text" id="new-profile-name" class="demo-input" placeholder="New Profile Name..." style="flex:1;">
                    <button class="search-btn" style="width:auto; padding:0 10px;" onclick="ProfileManager.saveCurrentPageAsProfile()">üíæ</button>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-size:10px; color:var(--text-secondary);">Manage Profiles:</span>
                    <button class="search-btn" style="background:#475569 !important; font-size:10px; padding:2px 8px; height:24px;" onclick="ConfigExporter.export()">Export Config</button>
                </div>
             </div>

             <div id="demo-context-panel" class="collapsed-state">
                <div class="context-header" onclick="DemoManager.toggleContext()">
                    <span>üî¨ Project Context</span>
                    <span id="context-toggle-icon">‚ñº</span>
                </div>
                
                <div id="demo-context-content" class="collapsed">
                    <span class="demo-label">Customer Name</span><input type="text" id="demo-cust-name" class="demo-input" placeholder="Enter Customer..." oninput="RedactionManager.refreshContent()">
                    <span class="demo-label">Job Name</span><input type="text" id="demo-job-name" class="demo-input" placeholder="Enter Job Name..." oninput="RedactionManager.refreshContent()">
                    <span class="demo-label">System Type</span><input type="text" id="demo-system-type" class="demo-input" placeholder="e.g. Duplex Pump..." oninput="RedactionManager.refreshContent()">
                    <span class="demo-label">Panel ID</span><input type="text" id="demo-panel-id" class="demo-input" placeholder="CP-####" oninput="RedactionManager.refreshContent()">
                    
                    <div style="display:flex; gap:5px;">
                        <div style="flex:1;"><span class="demo-label">Date</span><input type="date" id="demo-date" class="demo-input" oninput="RedactionManager.refreshContent()"></div>
                        <div style="flex:1;">
                            <span class="demo-label">Stage</span>
                            <select id="demo-stage" class="demo-input" onchange="RedactionManager.refreshContent()">
                                <option selected>SUBMITTAL</option>
                                <option>DESIGN</option>
                                <option>AS-BUILT</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div id="editor-controls" class="disabled-overlay">
                <div class="editor-section">
                    <span class="editor-label">CAD Font Style</span>
                    <select id="redact-font" class="cox-input" onchange="RedactionManager.updateActiveStyle()">
                        <option value="'Courier New', monospace">Monospace (Courier)</option>
                        <option value="'Times New Roman', serif">Standard (Times)</option>
                    </select>
                </div>

                <div class="editor-section">
                    <span class="editor-label">Alignment</span>
                    <div class="alignment-toggles">
                        <button class="align-btn" onclick="RedactionManager.updateActiveAlignment('left')" title="Left">‚´∑</button>
                        <button class="align-btn" onclick="RedactionManager.updateActiveAlignment('center')" title="Center">|||</button>
                        <button class="align-btn" onclick="RedactionManager.updateActiveAlignment('right')" title="Right">‚´∏</button>
                    </div>
                </div>
                
                <div class="editor-section">
                    <label class="editor-label" style="display:flex; align-items:center; cursor:pointer;">
                        <input type="checkbox" id="zone-bg-toggle" onchange="RedactionManager.toggleBoxBackground()" style="margin-right:8px;"> 
                        Opaque Background (Whiteout)
                    </label>
                </div>

                <div class="editor-section">
                    <span class="editor-label">Text Size (px)</span>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <input type="range" id="redact-size" min="8" max="72" value="14" style="flex:1;" oninput="RedactionManager.updateActiveStyle()">
                        <span id="font-size-val" style="width:30px; text-align:right; font-weight:bold; font-size:11px; color:var(--app-primary);">14</span>
                    </div>
                </div>

                <div class="editor-section">
                    <span class="editor-label">Mapped Data</span>
                    <select id="zone-map-select" class="cox-input" onchange="RedactionManager.mapSelectedZone()">
                        <option value="cust">Customer Name</option>
                        <option value="job">Job Name</option>
                        <option value="type">System Type</option>
                        <option value="cpid">Panel ID (CP-####)</option>
                        <option value="date">Date</option>
                        <option value="stage">Design Stage</option>
                        <option value="custom">Custom Text...</option>
                        <option value="logo">Branding/Logo (Block)</option>
                    </select>
                    
                    <div id="custom-text-wrapper" style="display:none; margin-top:5px;">
                        <input type="text" id="custom-zone-text" class="demo-input" placeholder="Type text here..." oninput="RedactionManager.updateCustomText(this.value)">
                    </div>
                </div>
            </div>
            
            <div style="margin-top:auto; display:flex; flex-direction:column; gap:5px;">
                <div style="display:flex; gap:5px;">
                    <button class="search-btn" style="background:var(--app-primary) !important;" onclick="RedactionManager.addZoneToCurrentView('custom')">‚ûï Text</button>
                    <button class="search-btn" style="background:var(--match-green-bg) !important;" onclick="RedactionManager.addZoneToCurrentView('blocker')">‚ûï Whiteout</button>
                </div>
                
                <button class="search-btn" style="background:#dc2626 !important;" onclick="RedactionManager.deleteSelected()">‚ùå Delete Selected</button>
                
                <button class="search-btn" style="background:var(--app-accent) !important; margin-top:5px;" onclick="LayoutScanner.scanAllPages()">üìÑ Auto-Scan Page</button>
                <button class="search-btn" style="background:#475569 !important;" onclick="PdfExporter.export()">üíæ Export Redacted PDF</button>
                <button class="search-btn" style="background:#555;" onclick="RedactionManager.clearAll()">üóëÔ∏è Clear All</button>
            </div>
        </div>
    </div>

    <button id="generator-restore-btn" onclick="DemoManager.restorePanel()" title="Open Generator Controls">‚öôÔ∏è</button>

<script src="app.js"></script>
</body>
</html>